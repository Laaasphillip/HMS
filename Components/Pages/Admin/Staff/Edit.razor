@page "/admin/staff/edit/{StaffId:int}"
@using HMS.Data
@using HMS.Models
@using HMS.Services
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject AdminService AdminService
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@attribute [Authorize(Policy = "AdminOnly")]
@rendermode InteractiveServer

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="bi bi-pencil-square me-2"></i>
                        Edit Staff @(staff != null ? $"- {staff.FirstName} {staff.LastName}" : "")
                    </h4>
                </div>
                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            @errorMessage
                        </div>
                        <button class="btn btn-secondary" @onclick="Cancel">
                            <i class="bi bi-arrow-left me-1"></i> Back to List
                        </button>
                    }
                    else
                    {
                        <EditForm Model="@staff" OnValidSubmit="HandleSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />

                            <div class="row">
                                <!-- Staff ID (Read-only) -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Staff ID</label>
                                    <input type="text" class="form-control" value="@StaffId" disabled />
                                </div>

                                <!-- First Name -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">First Name *</label>
                                    <InputText @bind-Value="staff.FirstName" class="form-control" placeholder="Enter first name" />
                                    <ValidationMessage For="@(() => staff.FirstName)" />
                                </div>

                                <!-- Last Name -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Last Name *</label>
                                    <InputText @bind-Value="staff.LastName" class="form-control" placeholder="Enter last name" />
                                    <ValidationMessage For="@(() => staff.LastName)" />
                                </div>

                                <!-- Specialization -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Specialization *</label>
                                    <InputText @bind-Value="staff.Specialization" class="form-control" placeholder="e.g., Cardiology, Emergency Care" />
                                    <ValidationMessage For="@(() => staff.Specialization)" />
                                </div>

                                <!-- Phone -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Phone</label>
                                    <InputText @bind-Value="staff.PhoneNumber" class="form-control" placeholder="+46 70 123 4567" />
                                    <ValidationMessage For="@(() => staff.PhoneNumber)" />
                                </div>
                                <!-- Personal-Number -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Personal Number (SSN)</label>
                                    <InputText @bind-Value="staff.PersonalNumber" class="form-control" placeholder="199002051234" />
                                    <ValidationMessage For="@(() => staff.PersonalNumber)" />
                                </div>

                                <!-- Email -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <InputText @bind-Value="staff.Email" type="email" class="form-control" placeholder="email@hospital.com" />
                                    <ValidationMessage For="@(() => staff.Email)" />
                                </div>

                                <!-- Hourly Rate -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Hourly Rate (SEK) *</label>
                                    <InputNumber @bind-Value="staff.HourlyRate" class="form-control" step="0.01" />
                                    <ValidationMessage For="@(() => staff.HourlyRate)" />
                                </div>

                                <!-- Hired Date -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Hired Date *</label>
                                    <InputDate @bind-Value="staff.HiredDate" class="form-control" />
                                    <ValidationMessage For="@(() => staff.HiredDate)" />
                                </div>

                                <!-- Department -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Department</label>
                                    <InputText @bind-Value="staff.Department" class="form-control" placeholder="e.g., Emergency, ICU" />
                                </div>

                                <!-- Contract Form -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Contract Form</label>
                                    <InputText @bind-Value="staff.ContractForm" class="form-control" placeholder="e.g., Full-time, Part-time" />
                                </div>

                                <!-- Vacation Days -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Vacation Days</label>
                                    <InputNumber @bind-Value="staff.Vacationdays" class="form-control" />
                                </div>

                                <!-- Taxes -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tax Rate (%)</label>
                                    <InputNumber @bind-Value="staff.Taxes" class="form-control" step="0.01" />
                                </div>

                                <!-- Bank Details -->
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Bank Details</label>
                                    <InputText @bind-Value="staff.Bankdetails" class="form-control" placeholder="Bank account information" />
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-2 mt-4">
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-check-circle me-1"></i> Update Staff
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                                    <i class="bi bi-x-circle me-1"></i> Cancel
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int StaffId { get; set; }

    private StaffEditModel staff = new();
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadStaffDataAsync();
    }

    private async Task LoadStaffDataAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var dbStaff = await AdminService.GetStaffByIdAsync(StaffId);

            if (dbStaff == null)
            {
                errorMessage = "Staff member not found";
                staff = new StaffEditModel();
                return;
            }

            // Map database model to edit model
            staff = new StaffEditModel
            {
                Id = dbStaff.Id,
                FirstName = dbStaff.User?.FirstName ?? "",
                LastName = dbStaff.User?.LastName ?? "",
                Specialization = dbStaff.Specialization ?? "",
                PhoneNumber = dbStaff.User?.PhoneNumber ?? "",
                PersonalNumber = dbStaff.User?.PersonalNumber ?? "",
                Email = dbStaff.User?.Email ?? "",
                HourlyRate = dbStaff.HourlyRate,
                HiredDate = dbStaff.HiredDate,
                Department = dbStaff.Department ?? "",
                ContractForm = dbStaff.ContractForm ?? "",
                Vacationdays = dbStaff.Vacationdays,
                Taxes = dbStaff.Taxes,
                Bankdetails = dbStaff.Bankdetails ?? "",
                UserId = dbStaff.UserId
            };
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading staff member: {ex.Message}";
            Console.WriteLine($"Error in LoadStaffDataAsync: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            // Load the existing staff from database
            var dbStaff = await AdminService.GetStaffByIdAsync(StaffId);

            if (dbStaff == null)
            {
                errorMessage = "Staff member not found";
                return;
            }

            // Update staff properties
            dbStaff.Specialization = staff.Specialization;
            dbStaff.HourlyRate = staff.HourlyRate;
            dbStaff.HiredDate = staff.HiredDate;
            dbStaff.Department = staff.Department;
            dbStaff.ContractForm = staff.ContractForm;
            dbStaff.Vacationdays = staff.Vacationdays;
            dbStaff.Taxes = staff.Taxes;
            dbStaff.Bankdetails = staff.Bankdetails;

            // Update user properties if User exists
            if (dbStaff.User != null)
            {
                dbStaff.User.FirstName = staff.FirstName;
                dbStaff.User.LastName = staff.LastName;
                dbStaff.User.PhoneNumber = staff.PhoneNumber;
                dbStaff.User.PersonalNumber = staff.PersonalNumber;
                dbStaff.User.Email = staff.Email;
            }

            var success = await AdminService.UpdateStaffAsync(dbStaff);

            if (success)
            {
                Navigation.NavigateTo("/admin/staff");
            }
            else
            {
                errorMessage = "Failed to update staff member";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving staff member: {ex.Message}";
            Console.WriteLine($"Error in HandleSubmit: {ex}");
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/admin/staff");
    }

    public class StaffEditModel
    {
        public int Id { get; set; }
        public string UserId { get; set; } = string.Empty;

        [Required(ErrorMessage = "First name is required")]
        [StringLength(100, ErrorMessage = "First name cannot exceed 100 characters")]
        public string FirstName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Last name is required")]
        [StringLength(100, ErrorMessage = "Last name cannot exceed 100 characters")]
        public string LastName { get; set; } = string.Empty;


        [Required(ErrorMessage = "Specialization is required")]
        [StringLength(100, ErrorMessage = "Specialization cannot exceed 100 characters")]
        public string Specialization { get; set; } = string.Empty;

        public string? PhoneNumber { get; set; }

        public string? PersonalNumber { get; set; }

        public string? Email { get; set; }

        [Required(ErrorMessage = "Hourly rate is required")]
        [Range(0.01, 10000, ErrorMessage = "Hourly rate must be between 0.01 and 10000")]
        public decimal HourlyRate { get; set; }

        [Required(ErrorMessage = "Hired date is required")]
        public DateTime HiredDate { get; set; }

        public string? Department { get; set; }

        public string? ContractForm { get; set; }

        public int Vacationdays { get; set; }

        public decimal Taxes { get; set; }

        public string? Bankdetails { get; set; }
    }
}
