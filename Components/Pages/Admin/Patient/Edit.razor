@page "/admin/patient/edit/{PatientId:int}"
@using HMS.Data
@using HMS.Models
@using HMS.Services
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject AdminService AdminService
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@attribute [Authorize(Policy = "AdminOnly")]
@rendermode InteractiveServer

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="bi bi-pencil-square me-2"></i>
                        Edit Patient @(patient != null ? $"- {patient.FirstName} {patient.LastName}" : "")
                    </h4>
                </div>
                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <EditForm Model="@patient" OnValidSubmit="HandleSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />

                            <div class="row">
                                <!-- Patient ID (Read-only) -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Patient ID</label>
                                    <input type="text" class="form-control" value="@PatientId" disabled />
                                </div>

                                <!-- First Name -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">First Name *</label>
                                    <InputText @bind-Value="patient.FirstName" class="form-control" placeholder="Enter first name" />
                                    <ValidationMessage For="@(() => patient.FirstName)" />
                                </div>

                                <!-- Last Name -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Last Name *</label>
                                    <InputText @bind-Value="patient.LastName" class="form-control" placeholder="Enter last name" />
                                    <ValidationMessage For="@(() => patient.LastName)" />
                                </div>

                                <!-- Date of Birth -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date of Birth *</label>
                                    <InputDate @bind-Value="patient.Dateofbirth" class="form-control" />
                                    <ValidationMessage For="@(() => patient.Dateofbirth)" />
                                </div>

                                <!-- Blood Group -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Blood Group *</label>
                                    <InputSelect @bind-Value="patient.BloodGroup" class="form-select">
                                        <option value="">Select Blood Group</option>
                                        <option value="A+">A+</option>
                                        <option value="A-">A-</option>
                                        <option value="B+">B+</option>
                                        <option value="B-">B-</option>
                                        <option value="AB+">AB+</option>
                                        <option value="AB-">AB-</option>
                                        <option value="O+">O+</option>
                                        <option value="O-">O-</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => patient.BloodGroup)" />
                                </div>

                                <!-- Email -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <InputText @bind-Value="patient.Email" type="email" class="form-control" placeholder="email@example.com" />
                                    <ValidationMessage For="@(() => patient.Email)" />
                                </div>

                                <!-- Personal-Number -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Personal Number (SSN)</label>
                                    <InputText @bind-Value="patient.PersonalNumber" class="form-control" placeholder="199002051234" />
                                    <ValidationMessage For="@(() => patient.PersonalNumber)" />
                                </div>

                                <!-- Phone -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Phone</label>
                                    <InputText @bind-Value="patient.PhoneNumber" class="form-control" placeholder="+46 70 123 4567" />
                                    <ValidationMessage For="@(() => patient.PhoneNumber)" />
                                </div>


                                <!-- Contact/Emergency Contact -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Emergency Contact *</label>
                                    <InputText @bind-Value="patient.Contact" class="form-control" placeholder="+46 70 987 6543" />
                                    <ValidationMessage For="@(() => patient.Contact)" />
                                </div>

                                <!-- Address -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Address</label>
                                    <InputText @bind-Value="patient.Address" class="form-control" placeholder="Street, City, Postal Code" />
                                </div>

                                <!-- Created At (Read-only) -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Registered Date</label>
                                    <input type="text" class="form-control" value="@patient.Createdat.ToString("yyyy-MM-dd HH:mm")" disabled />
                                </div>

                                <!-- Preferences -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Preferences</label>
                                    <InputText @bind-Value="patient.Preferences" class="form-control" placeholder="Patient preferences" />
                                </div>

                                <!-- Interests -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Interests</label>
                                    <InputText @bind-Value="patient.Interests" class="form-control" placeholder="Patient interests" />
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-2 mt-4">
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-check-circle me-1"></i> Update Patient
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                                    <i class="bi bi-x-circle me-1"></i> Cancel
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int PatientId { get; set; }

    private PatientEditModel patient = new();
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadPatientDataAsync();
    }

    private async Task LoadPatientDataAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var dbPatient = await AdminService.GetPatientByIdAsync(PatientId);

            if (dbPatient == null)
            {
                errorMessage = "Patient not found";
                patient = new PatientEditModel();
                return;
            }

            // Map database model to edit model
            patient = new PatientEditModel
            {
                Id = dbPatient.Id,
                FirstName = dbPatient.User?.FirstName ?? "",
                LastName = dbPatient.User?.LastName ?? "",
                Dateofbirth = dbPatient.Dateofbirth,
                BloodGroup = dbPatient.BloodGroup ?? "",
                PhoneNumber = dbPatient.User?.PhoneNumber ?? "",
                PersonalNumber = dbPatient.User?.PersonalNumber ?? "",
                Email = dbPatient.User?.Email ?? "",
                Contact = dbPatient.Contact ?? "",
                Address = dbPatient.Address ?? "",
                Preferences = dbPatient.Preferences ?? "",
                Interests = dbPatient.Interests ?? "",
                Createdat = dbPatient.Createdat,
                UserId = dbPatient.UserId
            };
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading patient: {ex.Message}";
            Console.WriteLine($"Error in LoadPatientDataAsync: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            // Load the existing patient from database
            var dbPatient = await AdminService.GetPatientByIdAsync(PatientId);

            if (dbPatient == null)
            {
                errorMessage = "Patient not found";
                return;
            }

            // Update patient properties
            dbPatient.Dateofbirth = patient.Dateofbirth;
            dbPatient.BloodGroup = patient.BloodGroup;
            dbPatient.Contact = patient.Contact;
            dbPatient.Address = patient.Address;
            dbPatient.Preferences = patient.Preferences;
            dbPatient.Interests = patient.Interests;

            // Update user properties if User exists
            if (dbPatient.User != null)
            {
                dbPatient.User.FirstName = patient.FirstName;
                dbPatient.User.LastName = patient.LastName;
                dbPatient.User.PhoneNumber = patient.PhoneNumber;
                dbPatient.User.PersonalNumber = patient.PersonalNumber;
                dbPatient.User.Email = patient.Email;
            }

            var success = await AdminService.UpdatePatientAsync(dbPatient);

            if (success)
            {
                Navigation.NavigateTo("/admin/patients");
            }
            else
            {
                errorMessage = "Failed to update patient";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving patient: {ex.Message}";
            Console.WriteLine($"Error in HandleSubmit: {ex}");
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/admin/patient");
    }

    public class PatientEditModel
    {
        public int Id { get; set; }
        public string UserId { get; set; } = string.Empty;

        [Required(ErrorMessage = "First name is required")]
        [StringLength(100, ErrorMessage = "First name cannot exceed 100 characters")]
        public string FirstName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Last name is required")]
        [StringLength(100, ErrorMessage = "Last name cannot exceed 100 characters")]
        public string LastName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Date of birth is required")]
        public DateTime Dateofbirth { get; set; }

        [Required(ErrorMessage = "Blood group is required")]
        public string BloodGroup { get; set; } = string.Empty;

        public string? PhoneNumber { get; set; }

        public string? PersonalNumber { get; set; }

        public string? Email { get; set; }

        [Required(ErrorMessage = "Emergency contact is required")]
        public string Contact { get; set; } = string.Empty;

        public string? Address { get; set; }

        public string? Preferences { get; set; }

        public string? Interests { get; set; }

        public DateTime Createdat { get; set; }
    }
}