@page "/schedule/details/{ScheduleId:int}"
@using HMS.Data
@using HMS.Models
@using HMS.Services
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject AdminService AdminService
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@attribute [Authorize(Policy = "AdminOrStaff")]
@rendermode InteractiveServer

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #877BAF;">
                    <h4 class="mb-0">
                        <i class="bi bi-calendar-check me-2"></i>
                        Schedule Details #@ScheduleId
                    </h4>
                    <div class="d-none d-lg-block">
                        <AuthorizeView Policy="AdminOnly">
                            <button class="btn btn-light btn-sm me-2" @onclick="EditSchedule">
                                <i class="bi bi-pencil me-1"></i> Edit
                            </button>
                        </AuthorizeView>
                        <button class="btn btn-outline-light btn-sm" @onclick="BackToList">
                            <i class="bi bi-arrow-left me-1"></i> Back
                        </button>
                    </div>
                    <div class="d-block d-lg-none">
                        <AuthorizeView Policy="AdminOnly">
                            <button class="btn btn-light btn-sm me-1" @onclick="EditSchedule" title="Edit Schedule">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </AuthorizeView>
                        <button class="btn btn-outline-light btn-sm" @onclick="BackToList" title="Back to list">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border" style="color: #877BAF;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            @errorMessage
                            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle me-2"></i>
                            @successMessage
                            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
                        </div>
                    }

                    @if (schedule != null)
                    {
                        <!-- Slot Generation Status Alert -->
                        @if (schedule.SlotsGenerated)
                        {
                            <div class="alert alert-success mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-check-circle-fill me-2"></i>
                                        <strong>Slots Generated:</strong> Appointment slots have been generated for this schedule.
                                        @if (generatedSlotsCount > 0)
                                        {
                                            <span class="badge bg-success ms-2">@generatedSlotsCount slots</span>
                                        }
                                    </div>
                                    <button class="btn btn-sm btn-warning" @onclick="RegenerateSlots" disabled="@isGenerating">
                                        @if (isGenerating)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        <i class="bi bi-arrow-clockwise me-1"></i> Regenerate
                                    </button>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        <strong>Slots Not Generated:</strong> Appointment slots have not been created yet for this schedule.
                                    </div>
                                    <button class="btn btn-sm btn-success" @onclick="GenerateSlots" disabled="@isGenerating">
                                        @if (isGenerating)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        <i class="bi bi-calendar-plus me-1"></i> Generate Slots
                                    </button>
                                </div>
                            </div>
                        }

                        <!-- Schedule Overview -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5 class="text-muted mb-3">Schedule Information</h5>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Schedule ID</label>
                                    <p class="mb-0"><span class="badge bg-secondary">#@schedule.Id</span></p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Staff Member</label>
                                    <p class="mb-0">
                                        @if (schedule.Staff?.User != null)
                                        {
                                            <strong>@GetStaffFullName(schedule.Staff)</strong>
                                            <br />
                                            <small class="text-muted">
                                                @if (!string.IsNullOrEmpty(schedule.Staff.Department))
                                                {
                                                    <span>@schedule.Staff.Department</span>
                                                }
                                                @if (!string.IsNullOrEmpty(schedule.Staff.Specialization))
                                                {
                                                    <span> - @schedule.Staff.Specialization</span>
                                                }
                                            </small>
                                        }
                                        else
                                        {
                                            <span class="text-muted">N/A</span>
                                        }
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Date</label>
                                    <p class="mb-0">
                                        <i class="bi bi-calendar3 me-2"></i>
                                        @schedule.Date.ToString("dddd, MMMM dd, yyyy")
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Shift Type</label>
                                    <p class="mb-0">
                                        @if (!string.IsNullOrEmpty(schedule.ShiftType))
                                        {
                                            <span class="badge bg-info">@schedule.ShiftType</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not specified</span>
                                        }
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Status</label>
                                    <p class="mb-0">
                                        <span class="badge @GetStatusBadgeClass(schedule.Status)">
                                            @(schedule.Status ?? "N/A")
                                        </span>
                                    </p>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="text-muted mb-3">Time Schedule</h5>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Start Time</label>
                                    <p class="mb-0">
                                        <i class="bi bi-clock me-2"></i>
                                        @schedule.StartTime.ToString(@"hh\:mm")
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">End Time</label>
                                    <p class="mb-0">
                                        <i class="bi bi-clock me-2"></i>
                                        @schedule.EndTime.ToString(@"hh\:mm")
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Total Duration</label>
                                    <p class="mb-0">
                                        <i class="bi bi-hourglass-split me-2"></i>
                                        @CalculateDuration(schedule.StartTime, schedule.EndTime) hours
                                    </p>
                                </div>

                                <hr />

                                <h6 class="text-muted mb-3">Break Time</h6>

                                @if (schedule.BreakStart.HasValue && schedule.BreakEnd.HasValue)
                                {
                                    <div class="mb-3">
                                        <label class="fw-bold text-muted small">Break Start</label>
                                        <p class="mb-0">
                                            <i class="bi bi-cup-hot me-2"></i>
                                            @schedule.BreakStart.Value.ToString(@"hh\:mm")
                                        </p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="fw-bold text-muted small">Break End</label>
                                        <p class="mb-0">
                                            <i class="bi bi-cup-hot me-2"></i>
                                            @schedule.BreakEnd.Value.ToString(@"hh\:mm")
                                        </p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="fw-bold text-muted small">Break Duration</label>
                                        <p class="mb-0">
                                            <i class="bi bi-hourglass-split me-2"></i>
                                            @CalculateDuration(schedule.BreakStart.Value, schedule.BreakEnd.Value) hours
                                        </p>
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted">No break time scheduled</p>
                                }
                            </div>
                        </div>

                        <!-- Appointment Slots Summary -->
                        @if (appointmentSlots.Any())
                        {
                            <hr />
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="text-muted mb-3">
                                        <i class="bi bi-calendar2-week me-2"></i>
                                        Appointment Slots (@appointmentSlots.Count)
                                    </h5>

                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="card bg-success bg-opacity-10 border-success">
                                                <div class="card-body text-center p-2">
                                                    <h4 class="mb-0">@appointmentSlots.Count(s => s.Status == "Available")</h4>
                                                    <small>Available</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-primary bg-opacity-10 border-primary">
                                                <div class="card-body text-center p-2">
                                                    <h4 class="mb-0">@appointmentSlots.Count(s => s.Status == "Booked")</h4>
                                                    <small>Booked</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-warning bg-opacity-10 border-warning">
                                                <div class="card-body text-center p-2">
                                                    <h4 class="mb-0">@appointmentSlots.Count(s => s.Status == "Blocked")</h4>
                                                    <small>Blocked</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-info bg-opacity-10 border-info">
                                                <div class="card-body text-center p-2">
                                                    <h4 class="mb-0">@appointmentSlots.Sum(s => s.CurrentBookings)</h4>
                                                    <small>Total Bookings</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Time</th>
                                                    <th>Status</th>
                                                    <th>Bookings</th>
                                                    <th>Capacity</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var slot in appointmentSlots.OrderBy(s => s.StartTime))
                                                {
                                                    <tr>
                                                        <td>@slot.StartTime.ToString(@"hh\:mm") - @slot.EndTime.ToString(@"hh\:mm")</td>
                                                        <td>
                                                            <span class="badge bg-@GetSlotStatusColor(slot.Status)">
                                                                @slot.Status
                                                            </span>
                                                        </td>
                                                        <td>@slot.CurrentBookings</td>
                                                        <td>@slot.MaxCapacity</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        }

                        <hr />

                        <!-- Additional Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Created At</label>
                                    <p class="mb-0">    
                                        <i class="bi bi-calendar-plus me-2"></i>
                                        @schedule.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                                    </p>
                                </div>
                            </div>

                            @if (schedule.UpdatedAt.HasValue)
                            {
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="fw-bold text-muted small">Last Updated</label>
                                        <p class="mb-0">
                                            <i class="bi bi-clock-history me-2"></i>
                                            @schedule.UpdatedAt.Value.ToString("yyyy-MM-dd HH:mm")
                                        </p>
                                    </div>
                                </div>
                            }

                            @if (schedule.TimeReport != null)
                            {
                                <div class="col-md-12 mt-3">
                                    <div class="alert alert-success">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-clock-history me-2"></i>
                                            Time Report
                                        </h6>
                                        <p class="mb-0">
                                            This schedule has a time report associated with it.
                                        </p>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-none d-lg-flex gap-2 mt-4">
                            @if (!schedule.SlotsGenerated)
                            {
                                <button class="btn btn-success" @onclick="GenerateSlots" disabled="@isGenerating">
                                    @if (isGenerating)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    }
                                    <i class="bi bi-calendar-plus me-1"></i> Generate Slots
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-warning" @onclick="RegenerateSlots" disabled="@isGenerating">
                                    @if (isGenerating)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    }
                                    <i class="bi bi-arrow-clockwise me-1"></i> Regenerate Slots
                                </button>
                            }
                            <AuthorizeView Policy="AdminOnly">
                                <button class="btn btn-primary" @onclick="EditSchedule">
                                    <i class="bi bi-pencil me-1"></i> Edit Schedule
                                </button>
                                <button class="btn btn-danger" @onclick="DeleteSchedule">
                                    <i class="bi bi-trash me-1"></i> Delete Schedule
                                </button>
                            </AuthorizeView>
                            <button class="btn btn-secondary ms-auto" @onclick="BackToList">
                                <i class="bi bi-arrow-left me-1"></i> Back to List
                            </button>
                        </div>
                        <div class="d-flex d-lg-none gap-2 mt-4 row">
                            <div class="col-12">
                                @if (!schedule.SlotsGenerated)
                                {
                                    <button class="btn btn-success me-1" @onclick="GenerateSlots" disabled="@isGenerating" title="Generate Slots">
                                        @if (isGenerating)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        <i class="bi bi-calendar-plus"></i>
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-warning me-1" @onclick="RegenerateSlots" disabled="@isGenerating" title="Regenerate Slots">
                                        @if (isGenerating)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                }

                                <AuthorizeView Policy="AdminOnly">
                                    <button class="btn btn-primary" @onclick="EditSchedule" title="Edit Schedule">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-danger" @onclick="DeleteSchedule" title="Delete Schedule">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </AuthorizeView>
                                <button class="btn btn-secondary ms-auto" @onclick="BackToList" title="Back to list">
                                    <i class="bi bi-arrow-left"></i>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int ScheduleId { get; set; }

    private Schedule? schedule;
    private List<AppointmentSlot> appointmentSlots = new();
    private int generatedSlotsCount = 0;

    private bool isLoading = true;
    private bool isGenerating = false;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadScheduleAsync();
    }

    private async Task LoadScheduleAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            schedule = await AdminService.GetScheduleByIdAsync(ScheduleId);

            if (schedule == null)
            {
                errorMessage = "Schedule not found";
            }
            else
            {
                // Load appointment slots for this schedule
                appointmentSlots = await AdminService.GetAllAppointmentSlotsAsync();
                appointmentSlots = appointmentSlots
                    .Where(s => s.ScheduleId == ScheduleId)
                    .ToList();

                generatedSlotsCount = appointmentSlots.Count;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading schedule: {ex.Message}";
            Console.WriteLine($"Error in LoadScheduleAsync: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GenerateSlots()
    {
        if (schedule == null) return;

        try
        {
            isGenerating = true;
            errorMessage = null;
            successMessage = null;

            var generatedSlots = await AdminService.GenerateSlotsForScheduleAsync(ScheduleId);

            successMessage = $"Successfully generated {generatedSlots.Count} appointment slots for this schedule!";

            // Reload to get updated data
            await LoadScheduleAsync();
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generating slots: {ex.Message}";
            Console.WriteLine($"Error in GenerateSlots: {ex}");
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task RegenerateSlots()
    {
        if (schedule == null) return;

        try
        {
            isGenerating = true;
            errorMessage = null;
            successMessage = null;

            var generatedSlots = await AdminService.RegenerateSlotsForScheduleAsync(ScheduleId);

            successMessage = $"Successfully regenerated {generatedSlots.Count} appointment slots for this schedule!";

            // Reload to get updated data
            await LoadScheduleAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error regenerating slots: {ex.Message}";
            Console.WriteLine($"Error in RegenerateSlots: {ex}");
        }
        finally
        {
            isGenerating = false;
        }
    }

    private string GetStaffFullName(Staff staff)
    {
        if (staff?.User != null)
        {
            var firstName = staff.User.FirstName ?? "";
            var lastName = staff.User.LastName ?? "";
            return $"{firstName} {lastName}".Trim();
        }
        return "N/A";
    }

    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLower() switch
        {
            "scheduled" => "bg-primary",
            "active" => "bg-success",
            "completed" => "bg-secondary",
            "cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetSlotStatusColor(string? status)
    {
        return status?.ToLower() switch
        {
            "available" => "success",
            "booked" => "primary",
            "blocked" => "warning",
            "cancelled" => "danger",
            _ => "secondary"
        };
    }

    private double CalculateDuration(TimeSpan start, TimeSpan end)
    {
        return Math.Round((end - start).TotalHours, 2);
    }

    private void EditSchedule()
    {
        NavigationManager.NavigateTo($"/admin/schedule/edit/{ScheduleId}");
    }

    private async Task DeleteSchedule()
    {
        try
        {
            var success = await AdminService.DeleteScheduleAsync(ScheduleId);
            if (success)
            {
                NavigationManager.NavigateTo("/schedules");
            }
            else
            {
                errorMessage = "Failed to delete schedule";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting schedule: {ex.Message}";
        }
    }

    private void BackToList()
    {
        NavigationManager.NavigateTo("/schedules");
    }
}