@page "/admin/schedule/details/{ScheduleId:int}"
@using HMS.Data
@using HMS.Models
@using HMS.Services
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject AdminService AdminService
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@attribute [Authorize(Policy = "AdminOrStaff")]
@rendermode InteractiveServer

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #877BAF;">
                    <h4 class="mb-0">
                        <i class="bi bi-calendar-check me-2"></i>
                        Schedule Details #@ScheduleId
                    </h4>
                    <div>
                        <button class="btn btn-light btn-sm me-2" @onclick="EditSchedule">
                            <i class="bi bi-pencil me-1"></i> Edit
                        </button>
                        <button class="btn btn-outline-light btn-sm" @onclick="BackToList">
                            <i class="bi bi-arrow-left me-1"></i> Back
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border" style="color: #877BAF;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            @errorMessage
                        </div>
                        <button class="btn btn-secondary" @onclick="BackToList">
                            <i class="bi bi-arrow-left me-1"></i> Back to List
                        </button>
                    }
                    else if (schedule != null)
                    {
                        <!-- Schedule Overview -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5 class="text-muted mb-3">Schedule Information</h5>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Schedule ID</label>
                                    <p class="mb-0"><span class="badge bg-secondary">#@schedule.Id</span></p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Staff Member</label>
                                    <p class="mb-0">
                                        @if (schedule.Staff?.User != null)
                                        {
                                            <strong>@GetStaffFullName(schedule.Staff)</strong>
                                            <br />
                                            <small class="text-muted">
                                                @if (!string.IsNullOrEmpty(schedule.Staff.Specialization))
                                                {
                                                    <span> - @schedule.Staff.Specialization</span>
                                                }
                                            </small>
                                        }
                                        else
                                        {
                                            <span class="text-muted">N/A</span>
                                        }
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Date</label>
                                    <p class="mb-0">
                                        <i class="bi bi-calendar3 me-2"></i>
                                        @schedule.StartTime.ToString("dddd, MMMM dd, yyyy")
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Shift Type</label>
                                    <p class="mb-0">
                                        @if (!string.IsNullOrEmpty(schedule.ShiftType))
                                        {
                                            <span class="badge bg-info">@schedule.ShiftType</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not specified</span>
                                        }
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Status</label>
                                    <p class="mb-0">
                                        <span class="badge @GetStatusBadgeClass(schedule.Status)">
                                            @(schedule.Status ?? "N/A")
                                        </span>
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Availability</label>
                                    <p class="mb-0">
                                        @if (schedule.IsAvailable)
                                        {
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle me-1"></i>Available for Appointments
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-x-circle me-1"></i>Not Available
                                            </span>
                                        }
                                    </p>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="text-muted mb-3">Time Schedule</h5>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Start Time</label>
                                    <p class="mb-0">
                                        <i class="bi bi-clock me-2"></i>
                                        @schedule.StartTime.ToString("HH:mm")
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">End Time</label>
                                    <p class="mb-0">
                                        <i class="bi bi-clock me-2"></i>
                                        @schedule.EndTime.ToString("HH:mm")
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Total Duration</label>
                                    <p class="mb-0">
                                        <i class="bi bi-hourglass-split me-2"></i>
                                        @CalculateDuration(schedule.StartTime, schedule.EndTime) hours
                                    </p>
                                </div>

                                <hr />

                                <h6 class="text-muted mb-3">Break Time</h6>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Break Start</label>
                                    <p class="mb-0">
                                        <i class="bi bi-cup-hot me-2"></i>
                                        @schedule.BreakStart.ToString("HH:mm")
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Break End</label>
                                    <p class="mb-0">
                                        <i class="bi bi-cup-hot me-2"></i>
                                        @schedule.BreakEnd.ToString("HH:mm")
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Break Duration</label>
                                    <p class="mb-0">
                                        <i class="bi bi-hourglass-split me-2"></i>
                                        @CalculateDuration(schedule.BreakStart, schedule.BreakEnd) hours
                                    </p>
                                </div>
                            </div>
                        </div>

                        <hr />

                        <!-- Additional Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="fw-bold text-muted small">Created At</label>
                                    <p class="mb-0">
                                        <i class="bi bi-calendar-plus me-2"></i>
                                        @schedule.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                                    </p>
                                </div>
                            </div>

                            @if (schedule.Appointment != null)
                            {
                                <div class="col-md-12 mt-3">
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-calendar-event me-2"></i>
                                            Associated Appointment
                                        </h6>
                                        <p class="mb-0">
                                            This schedule has an associated appointment.
                                            <a href="/admin/appointment/details/@schedule.Appointment.Id" class="alert-link">View Appointment Details</a>
                                        </p>
                                    </div>
                                </div>
                            }

                            @if (schedule.TimeReport != null)
                            {
                                <div class="col-md-12 mt-3">
                                    <div class="alert alert-success">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-clock-history me-2"></i>
                                            Time Report
                                        </h6>
                                        <p class="mb-0">
                                            This schedule has a time report associated with it.
                                        </p>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 mt-4">
                            <button class="btn btn-primary" @onclick="EditSchedule">
                                <i class="bi bi-pencil me-1"></i> Edit Schedule
                            </button>
                            <button class="btn btn-danger" @onclick="DeleteSchedule">
                                <i class="bi bi-trash me-1"></i> Delete Schedule
                            </button>
                            <button class="btn btn-secondary ms-auto" @onclick="BackToList">
                                <i class="bi bi-arrow-left me-1"></i> Back to List
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int ScheduleId { get; set; }

    private Schedule? schedule;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadScheduleAsync();
    }

    private async Task LoadScheduleAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            schedule = await AdminService.GetScheduleByIdAsync(ScheduleId);

            if (schedule == null)
            {
                errorMessage = "Schedule not found";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading schedule: {ex.Message}";
            Console.WriteLine($"Error in LoadScheduleAsync: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetStaffFullName(Staff staff)
    {
        if (staff?.User != null)
        {
            var firstName = staff.User.FirstName ?? "";
            var lastName = staff.User.LastName ?? "";
            return $"{firstName} {lastName}".Trim();
        }
        return "N/A";
    }

    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLower() switch
        {
            "available" => "bg-success",
            "booked" => "bg-primary",
            "blocked" => "bg-warning text-dark",
            "completed" => "bg-info",
            "cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private double CalculateDuration(DateTime start, DateTime end)
    {
        return (end - start).TotalHours;
    }

    private void EditSchedule()
    {
        Navigation.NavigateTo($"/admin/schedule/edit/{ScheduleId}");
    }

    private async Task DeleteSchedule()
    {
        // In a real app, show a confirmation dialog
        if (confirm("Are you sure you want to delete this schedule?"))
        {
            try
            {
                var success = await AdminService.DeleteScheduleAsync(ScheduleId);
                if (success)
                {
                    Navigation.NavigateTo("/admin/schedules");
                }
                else
                {
                    errorMessage = "Failed to delete schedule";
                }
            }
            catch (Exception ex)
            {
                errorMessage = $"Error deleting schedule: {ex.Message}";
            }
        }
    }

    private void BackToList()
    {
        Navigation.NavigateTo("/admin/schedules");
    }

    private bool confirm(string message)
    {
        // In a real app, use a proper modal/dialog component
        return true; // Simplified for now
    }
}
