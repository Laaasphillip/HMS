@page "/admin/schedule/create"
@using HMS.Models
@using HMS.Services
@using System.ComponentModel.DataAnnotations
@inject AdminService AdminService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header text-white" style="background-color: #877BAF;">
                    <h4 class="mb-0">
                        <i class="bi bi-calendar-plus me-2"></i>
                        Create New Schedule
                    </h4>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            @errorMessage
                        </div>
                    }

                    <EditForm Model="@schedule" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger mb-3" />

                        <div class="row">
                            <!-- Staff Selection -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Staff Member *</label>
                                <InputSelect @bind-Value="schedule.StaffId" class="form-select">
                                    <option value="0">Select Staff</option>
                                    @foreach (var staff in staffList)
                                    {
                                        <option value="@staff.Id">@staff.FullName (@staff.Role)</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => schedule.StaffId)" />
                            </div>

                            <!-- Schedule Date -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Schedule Date *</label>
                                <InputDate @bind-Value="schedule.ScheduleDate" class="form-control" />
                                <ValidationMessage For="@(() => schedule.ScheduleDate)" />
                            </div>

                            <!-- Shift Type -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Shift Type</label>
                                <InputSelect @bind-Value="schedule.ShiftType" class="form-select">
                                    <option value="">Select Shift Type</option>
                                    <option value="Morning">Morning</option>
                                    <option value="Afternoon">Afternoon</option>
                                    <option value="Evening">Evening</option>
                                    <option value="Night">Night</option>
                                    <option value="Full Day">Full Day</option>
                                </InputSelect>
                            </div>

                            <!-- Status -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status *</label>
                                <InputSelect @bind-Value="schedule.Status" class="form-select">
                                    <option value="">Select Status</option>
                                    <option value="Available">Available</option>
                                    <option value="Blocked">Blocked</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => schedule.Status)" />
                            </div>

                            <!-- Start Time -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Time *</label>
                                <input type="time"
                                       class="form-control"
                                       value="@schedule.StartTimeString"
                                       @onchange="(e) => HandleTimeChange(e, nameof(schedule.StartTimeString))" />
                                <ValidationMessage For="@(() => schedule.StartTimeString)" />
                            </div>

                            <!-- End Time -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Time *</label>
                                <input type="time"
                                       class="form-control"
                                       value="@schedule.EndTimeString"
                                       @onchange="(e) => HandleTimeChange(e, nameof(schedule.EndTimeString))" />
                                <ValidationMessage For="@(() => schedule.EndTimeString)" />
                            </div>

                            <!-- Break Start Time -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Break Start Time</label>
                                <input type="time"
                                       class="form-control"
                                       value="@schedule.BreakStartTimeString"
                                       @onchange="(e) => HandleTimeChange(e, nameof(schedule.BreakStartTimeString))" />
                            </div>

                            <!-- Break End Time -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Break End Time</label>
                                <input type="time"
                                       class="form-control"
                                       value="@schedule.BreakEndTimeString"
                                       @onchange="(e) => HandleTimeChange(e, nameof(schedule.BreakEndTimeString))" />
                            </div>

                            <!-- Is Available -->
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    <InputCheckbox @bind-Value="schedule.IsAvailable" class="form-check-input" id="isAvailable" />
                                    <label class="form-check-label" for="isAvailable">
                                        Mark as available for appointments
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Duration Preview -->
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Schedule Duration:</strong> @CalculateDuration() hours
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn text-white" style="background-color: #877BAF;">
                                <i class="bi bi-check-circle me-1"></i> Create Schedule
                            </button>
                            <button type="button" class="btn btn-secondary" @onclick="Cancel">
                                <i class="bi bi-x-circle me-1"></i> Cancel
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    public class StaffSummary
    {
        public int Id { get; set; }
        public string FullName { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
    }

    private ScheduleCreateModel schedule = new();
    private List<StaffSummary> staffList = new();
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadStaffListAsync();
    }

    private async Task LoadStaffListAsync()
    {
        try
        {
            var staffMembers = await AdminService.GetAllStaffAsync();
            staffList = staffMembers.Select(s => new StaffSummary
            {
                Id = s.Id,
                FullName = s.User != null ? $"{s.User.FirstName} {s.User.LastName}".Trim() : "N/A",
                Role = s.User?.Role ?? "N/A"
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading staff list: {ex.Message}");
            staffList = new List<StaffSummary>();
        }
    }

    private void HandleTimeChange(ChangeEventArgs e, string propertyName)
    {
        var timeString = e.Value?.ToString();

        if (string.IsNullOrEmpty(timeString))
        {
            // Set default time or leave as current value
            return;
        }

        if (TimeSpan.TryParse(timeString, out var timeSpan))
        {
            switch (propertyName)
            {
                case nameof(ScheduleCreateModel.StartTimeString):
                    schedule.StartTimeString = timeString;
                    break;
                case nameof(ScheduleCreateModel.EndTimeString):
                    schedule.EndTimeString = timeString;
                    break;
                case nameof(ScheduleCreateModel.BreakStartTimeString):
                    schedule.BreakStartTimeString = timeString;
                    break;
                case nameof(ScheduleCreateModel.BreakEndTimeString):
                    schedule.BreakEndTimeString = timeString;
                    break;
            }
            StateHasChanged();
        }
    }

    private double CalculateDuration()
    {
        if (TimeSpan.TryParse(schedule.StartTimeString, out var startTime) &&
            TimeSpan.TryParse(schedule.EndTimeString, out var endTime))
        {
            return (endTime - startTime).TotalHours;
        }
        return 0;
    }

    private async Task HandleSubmit()
    {
        try
        {
            // Validate required times
            if (!TimeSpan.TryParse(schedule.StartTimeString, out var startTime) ||
                !TimeSpan.TryParse(schedule.EndTimeString, out var endTime))
            {
                errorMessage = "Please enter valid start and end times";
                return;
            }

            // Parse break times with fallback to default values
            TimeSpan breakStartTime = TimeSpan.Zero;
            TimeSpan breakEndTime = TimeSpan.Zero;

            if (!string.IsNullOrEmpty(schedule.BreakStartTimeString))
                TimeSpan.TryParse(schedule.BreakStartTimeString, out breakStartTime);

            if (!string.IsNullOrEmpty(schedule.BreakEndTimeString))
                TimeSpan.TryParse(schedule.BreakEndTimeString, out breakEndTime);

            // Create a new schedule
            var newSchedule = new Schedule
            {
                StaffId = schedule.StaffId,
                StartTime = schedule.ScheduleDate.Add(startTime),
                EndTime = schedule.ScheduleDate.Add(endTime),
                BreakStart = schedule.ScheduleDate.Add(breakStartTime),
                BreakEnd = schedule.ScheduleDate.Add(breakEndTime),
                ShiftType = schedule.ShiftType,
                Status = schedule.Status,
                IsAvailable = schedule.IsAvailable,
                CreatedAt = DateTime.UtcNow
            };

            var createdSchedule = await AdminService.CreateScheduleAsync(newSchedule);

            if (createdSchedule != null)
            {
                Navigation.NavigateTo("/Admin/Schedule");
            }
            else
            {
                errorMessage = "Failed to create schedule. There may be a schedule conflict or staff member not found.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating schedule: {ex.Message}";
            Console.WriteLine($"Error in HandleSubmit: {ex}");
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/Admin/Schedule");
    }

    public class ScheduleCreateModel
    {
        [Required(ErrorMessage = "Staff member is required")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a staff member")]
        public int StaffId { get; set; }

        [Required(ErrorMessage = "Schedule date is required")]
        [DataType(DataType.Date)]
        public DateTime ScheduleDate { get; set; } = DateTime.Today.AddDays(1);

        [Required(ErrorMessage = "Start time is required")]
        [RegularExpression(@"^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$", ErrorMessage = "Please enter a valid time in HH:mm format")]
        public string StartTimeString { get; set; } = "09:00";

        [Required(ErrorMessage = "End time is required")]
        [RegularExpression(@"^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$", ErrorMessage = "Please enter a valid time in HH:mm format")]
        public string EndTimeString { get; set; } = "17:00";

        [RegularExpression(@"^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$", ErrorMessage = "Please enter a valid time in HH:mm format")]
        public string BreakStartTimeString { get; set; } = "12:00";

        [RegularExpression(@"^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$", ErrorMessage = "Please enter a valid time in HH:mm format")]
        public string BreakEndTimeString { get; set; } = "12:30";

        public string ShiftType { get; set; } = string.Empty;

        [Required(ErrorMessage = "Status is required")]
        public string Status { get; set; } = "Available";

        public bool IsAvailable { get; set; } = true;
    }
}