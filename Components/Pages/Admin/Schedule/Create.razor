@page "/admin/schedule/create"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@using System.ComponentModel.DataAnnotations

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header text-white" style="background-color: #877BAF;">
                    <h4 class="mb-0">
                        <i class="bi bi-calendar-plus me-2"></i>
                        Create New Schedule
                    </h4>
                </div>
                <div class="card-body">
                    <EditForm Model="@schedule" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger mb-3" />

                        <div class="row">
                            <!-- Staff Selection -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Staff Member *</label>
                                <InputSelect @bind-Value="schedule.StaffId" class="form-select">
                                    <option value="0">Select Staff</option>
                                    @foreach (var staff in staffList)
                                    {
                                        <option value="@staff.StaffId">@staff.FullName (@staff.Role)</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => schedule.StaffId)" />
                            </div>

                            <!-- Schedule Date -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Schedule Date *</label>
                                <InputDate @bind-Value="schedule.ScheduleDate" class="form-control" />
                                <ValidationMessage For="@(() => schedule.ScheduleDate)" />
                            </div>

                            <!-- Start Time -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Time *</label>
                                <input type="time"
                                       value="@schedule.StartTime.ToString(@"hh\:mm")"
                                       @onchange="@((ChangeEventArgs e) => schedule.StartTime = TimeSpan.Parse(e.Value.ToString()))" />
                                <ValidationMessage For="@(() => schedule.StartTime)" />
                            </div>

                            <!-- End Time -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Time *</label>
                                <input type="time"
                                       value="@schedule.EndTime.ToString(@"hh\:mm")"
                                       @onchange="@((ChangeEventArgs e) => schedule.EndTime = TimeSpan.Parse(e.Value.ToString()))" />
                                <ValidationMessage For="@(() => schedule.EndTime)" />
                            </div>

                            <!-- Start Time -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Break Start Time *</label>
                                <input type="time"
                                       value="@schedule.BreakStartTime.ToString(@"hh\:mm")"
                                       @onchange="@((ChangeEventArgs e) => schedule.BreakStartTime = TimeSpan.Parse(e.Value.ToString()))" />
                                <ValidationMessage For="@(() => schedule.BreakStartTime)" />
                            </div>

                            <!-- End Time -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Break End Time *</label>
                                <input type="time"
                                       value="@schedule.BreakEndTime.ToString(@"hh\:mm")"
                                       @onchange="@((ChangeEventArgs e) => schedule.BreakEndTime = TimeSpan.Parse(e.Value.ToString()))" />
                                <ValidationMessage For="@(() => schedule.BreakEndTime)" />
                            </div>

                            <!-- Status -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status *</label>
                                <InputSelect @bind-Value="schedule.Status" class="form-select">
                                    <option value="">Select Status</option>
                                    <option value="Available">Available</option>
                                    <option value="Blocked">Blocked</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => schedule.Status)" />
                            </div>

                            <!-- Slot Duration -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Slot Duration (minutes)</label>
                                <InputNumber @bind-Value="schedule.SlotDuration" class="form-control" placeholder="30" />
                                <small class="form-text text-muted">Leave empty to create single slot</small>
                            </div>

                            <!-- Recurring Schedule -->
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="schedule.IsRecurring" id="recurring">
                                    <label class="form-check-label" for="recurring">
                                        Make this a recurring schedule
                                    </label>
                                </div>
                            </div>

                            @if (schedule.IsRecurring)
                            {
                                <!-- Recurring Days -->
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Repeat On *</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="checkbox" class="btn-check" id="mon" @bind="schedule.Monday">
                                        <label class="btn btn-outline-secondary" for="mon">Mon</label>

                                        <input type="checkbox" class="btn-check" id="tue" @bind="schedule.Tuesday">
                                        <label class="btn btn-outline-secondary" for="tue">Tue</label>

                                        <input type="checkbox" class="btn-check" id="wed" @bind="schedule.Wednesday">
                                        <label class="btn btn-outline-secondary" for="wed">Wed</label>

                                        <input type="checkbox" class="btn-check" id="thu" @bind="schedule.Thursday">
                                        <label class="btn btn-outline-secondary" for="thu">Thu</label>

                                        <input type="checkbox" class="btn-check" id="fri" @bind="schedule.Friday">
                                        <label class="btn btn-outline-secondary" for="fri">Fri</label>

                                        <input type="checkbox" class="btn-check" id="sat" @bind="schedule.Saturday">
                                        <label class="btn btn-outline-secondary" for="sat">Sat</label>

                                        <input type="checkbox" class="btn-check" id="sun" @bind="schedule.Sunday">
                                        <label class="btn btn-outline-secondary" for="sun">Sun</label>
                                    </div>
                                </div>

                                <!-- End Date -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">End Date *</label>
                                    <InputDate @bind-Value="schedule.RecurringEndDate" class="form-control" />
                                </div>
                            }

                            <!-- Notes -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Notes</label>
                                <InputTextArea @bind-Value="schedule.Notes" class="form-control" rows="3" placeholder="Any additional notes..." />
                            </div>
                        </div>

                        <!-- Preview -->
                        @if (schedule.SlotDuration.HasValue && schedule.SlotDuration > 0)
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Schedule Preview:</strong>
                                This will create @CalculateSlots() time slots of @schedule.SlotDuration minutes each.
                            </div>
                        }

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn text-white" style="background-color: #877BAF;">
                                <i class="bi bi-check-circle me-1"></i> Create Schedule
                            </button>
                            <button type="button" class="btn btn-secondary" @onclick="Cancel">
                                <i class="bi bi-x-circle me-1"></i> Cancel
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    public class StaffSummary
    {
        public int StaffId { get; set; }
        public string FullName { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
    }

    private ScheduleCreateModel schedule = new()
    {
        ScheduleDate = DateTime.Today.AddDays(1),
        StartTime = new TimeSpan(9, 0, 0),
        EndTime = new TimeSpan(17, 0, 0),
        BreakStartTime = new TimeSpan(12, 0, 0),
        BreakEndTime = new TimeSpan(12, 30, 0),
        Status = "Available"
    };

    private List<StaffSummary> staffList = new();

    protected override void OnInitialized()
    {
        LoadStaffList();
    }

    private void LoadStaffList()
    {
        staffList = new List<StaffSummary>
        {
            new StaffSummary { StaffId = 2001, FullName = "Dr. Sarah Williams", Role = "Doctor" },
            new StaffSummary { StaffId = 2002, FullName = "Dr. James Peterson", Role = "Doctor" },
            new StaffSummary { StaffId = 2003, FullName = "Nurse Maria Karlsson", Role = "Nurse" },
            new StaffSummary { StaffId = 2004, FullName = "Dr. Henrik Olsson", Role = "Doctor" },
            new StaffSummary { StaffId = 2005, FullName = "Nurse Emma Nilsson", Role = "Nurse" },
            new StaffSummary { StaffId = 2006, FullName = "Dr. Linda Gustafsson", Role = "Doctor" }
        };
    }

    private int CalculateSlots()
    {
        if (!schedule.SlotDuration.HasValue || schedule.SlotDuration.Value == 0)
            return 0;

        var totalMinutes = (schedule.EndTime - schedule.StartTime).TotalMinutes;
        return (int)(totalMinutes / schedule.SlotDuration.Value);
    }

    private void HandleSubmit()
    {
        // In real app, save to database
        // If recurring, create multiple schedule entries
        // If slot duration specified, create multiple time slots
        Navigation.NavigateTo("/Admin/Schedule");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/Admin/Schedule");
    }

    public class ScheduleCreateModel
    {
        [Required(ErrorMessage = "Staff member is required")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a staff member")]
        public int StaffId { get; set; }

        [Required(ErrorMessage = "Schedule date is required")]
        [DataType(DataType.Date)]
        public DateTime ScheduleDate { get; set; }

        [Required(ErrorMessage = "Start time is required")]
        public TimeSpan StartTime { get; set; }

        [Required(ErrorMessage = "End time is required")]
        public TimeSpan EndTime { get; set; }

        [Required(ErrorMessage = "Start time is required")]
        public TimeSpan BreakStartTime { get; set; }

        [Required(ErrorMessage = "End time is required")]
        public TimeSpan BreakEndTime { get; set; }

        [Required(ErrorMessage = "Status is required")]
        public string Status { get; set; } = string.Empty;

        [Range(5, 480, ErrorMessage = "Slot duration must be between 5 and 480 minutes")]
        public int? SlotDuration { get; set; }

        public bool IsRecurring { get; set; }

        public bool Monday { get; set; }
        public bool Tuesday { get; set; }
        public bool Wednesday { get; set; }
        public bool Thursday { get; set; }
        public bool Friday { get; set; }
        public bool Saturday { get; set; }
        public bool Sunday { get; set; }

        public DateTime? RecurringEndDate { get; set; }

        [StringLength(500, ErrorMessage = "Notes cannot exceed 500 characters")]
        public string? Notes { get; set; }
    }
}