@page "/admin/schedules"
@using HMS.Models
@using HMS.Services
@using Microsoft.AspNetCore.Authorization
@using Radzen
@using Radzen.Blazor
@attribute [Authorize(Policy = "AdminOrStaff")]
@inject AdminService AdminService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Schedules Management</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>Schedules Calendar</h2>
            <p class="text-muted">Manage staff schedules and shifts</p>
        </div>
        <div class="col-auto">
            <AuthorizeView Policy="AdminOrStaff">
                <button class="btn btn-primary" @onclick="CreateSchedule">
                    <i class="bi bi-plus-circle"></i> New Schedule
                </button>
            </AuthorizeView>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading schedules...</p>
        </div>
    }
    else
    {
        <!-- Filters and Controls -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label class="form-label">View Type</label>
                        <select class="form-select" @bind="currentView" @bind:after="OnViewChanged">
                            <option value="Month">Month Calendar</option>
                            <option value="Timeline">Timeline View</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Filter by Staff</label>
                        <select class="form-select" @bind="selectedStaffFilter" @bind:after="FilterSchedules">
                            <option value="0">All Staff</option>
                            @foreach (var staff in staffMembers)
                            {
                                <option value="@staff.Id">@staff.User?.FirstName @staff.User?.LastName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Filter by Status</label>
                        <select class="form-select" @bind="selectedStatusFilter" @bind:after="FilterSchedules">
                            <option value="">All Statuses</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Active">Active</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="text-center p-2 bg-primary bg-opacity-10 rounded">
                            <h6 class="mb-0">Total Schedules</h6>
                            <h4 class="mb-0">@filteredSchedules.Count</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                            <h6 class="mb-0">Active</h6>
                            <h4 class="mb-0">@filteredSchedules.Count(s => s.Status == "Active")</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-2 bg-warning bg-opacity-10 rounded">
                            <h6 class="mb-0">Scheduled</h6>
                            <h4 class="mb-0">@filteredSchedules.Count(s => s.Status == "Scheduled")</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-2 bg-info bg-opacity-10 rounded">
                            <h6 class="mb-0">Available</h6>
                            <h4 class="mb-0">@filteredSchedules.Count(s => s.IsAvailable)</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Views -->
        @if (currentView == "Month")
        {
            <div class="card">
                <div class="card-body">
                    <RadzenScheduler @ref="scheduler"
                                     TItem="ScheduleAppointmentData"
                                     Data="@appointmentData"
                                     StartProperty="Start"
                                     EndProperty="End"
                                     TextProperty="Text"
                                     AppointmentSelect="@OnAppointmentSelect"
                                     SlotSelect="@OnSlotSelect"
                                     CurrentDate="@currentDate"
                                     style="height: 768px;">
                        <RadzenMonthView />
                    </RadzenScheduler>
                </div>
            </div>
        }
        else
        {
            <!-- Custom Timeline View -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Timeline View - Week of @currentDate.ToString("MMM dd, yyyy")</h5>
                    <div class="col-md-3">
                        <div class="btn-group w-100">
                            <button class="btn btn-outline-secondary" @onclick="GoPrevious">
                                <i class="bi bi-chevron-left"></i> Prev
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="GoToday">Today</button>
                            <button class="btn btn-outline-secondary" @onclick="GoNext">
                                Next <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th style="width: 150px;">Staff</th>
                                    @for (int i = 0; i < 7; i++)
                                    {
                                        var day = GetWeekStart().AddDays(i);
                                        <th class="text-center">
                                            <div>@day.ToString("ddd")</div>
                                            <div class="small text-muted">@day.ToString("MMM dd")</div>
                                        </th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var staff in staffMembers.Where(s => selectedStaffFilter == 0 || s.Id == selectedStaffFilter))
                                {
                                    <tr>
                                        <td>
                                            <div><strong>@staff.User?.FirstName @staff.User?.LastName</strong></div>
                                            <small class="text-muted">@staff.Department</small>
                                        </td>
                                        @for (int i = 0; i < 7; i++)
                                        {
                                            var day = GetWeekStart().AddDays(i);
                                            var daySchedules = filteredSchedules
                                            .Where(s => s.StaffId == staff.Id &&
                                            s.StartTime.Date == day.Date)
                                            .OrderBy(s => s.StartTime)
                                            .ToList();
                                            <td class="p-1" style="vertical-align: top;">
                                                @foreach (var schedule in daySchedules)
                                                {
                                                    <div class="mb-1 p-2 rounded cursor-pointer @GetScheduleCardClass(schedule)"
                                                         @onclick="() => EditSchedule(schedule.Id)"
                                                         style="cursor: pointer; font-size: 0.85rem;">
                                                        <div><strong>@schedule.StartTime.ToString("HH:mm") - @schedule.EndTime.ToString("HH:mm")</strong></div>
                                                        <div><span class="badge bg-@GetShiftTypeColor(schedule.ShiftType)">@schedule.ShiftType</span></div>
                                                        <div class="small">
                                                            <span class="badge bg-@GetStatusColor(schedule.Status)">@schedule.Status</span>
                                                            @if (schedule.IsAvailable)
                                                            {
                                                                <span class="badge bg-success">Available</span>
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                                @if (!daySchedules.Any())
                                                {
                                                    <div class="text-muted text-center small">No schedule</div>
                                                }
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private RadzenScheduler<ScheduleAppointmentData>? scheduler;
    private List<HMS.Models.Schedule> schedules = new();
    private List<HMS.Models.Staff> staffMembers = new();
    private List<HMS.Models.Schedule> filteredSchedules = new();
    private List<ScheduleAppointmentData> appointmentData = new();

    private string currentView = "Month";
    private DateTime currentDate = DateTime.Today;
    private int selectedStaffFilter = 0;
    private string selectedStatusFilter = "";

    private bool loading = true;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            loading = true;
            errorMessage = null;
            schedules = await AdminService.GetAllSchedulesAsync();
            staffMembers = await AdminService.GetAllStaffAsync();
            FilterSchedules();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private void FilterSchedules()
    {
        filteredSchedules = schedules.ToList();

        if (selectedStaffFilter > 0)
        {
            filteredSchedules = filteredSchedules.Where(s => s.StaffId == selectedStaffFilter).ToList();
        }

        if (!string.IsNullOrEmpty(selectedStatusFilter))
        {
            filteredSchedules = filteredSchedules.Where(s => s.Status == selectedStatusFilter).ToList();
        }

        // Transform to appointment data for calendar
        appointmentData = filteredSchedules.Select(s => new ScheduleAppointmentData
        {
            ScheduleId = s.Id,
            Start = s.StartTime,
            End = s.EndTime,
            Text = $"{s.Staff?.User?.FirstName} {s.Staff?.User?.LastName} - {s.ShiftType}",
            StaffId = s.StaffId,
            ShiftType = s.ShiftType,
            Status = s.Status,
            IsAvailable = s.IsAvailable
        }).ToList();

        StateHasChanged();
    }

    private void OnViewChanged()
    {
        StateHasChanged();
    }

    private void GoPrevious()
    {
        if (currentView == "Month")
        {
            currentDate = currentDate.AddMonths(-1);
        }
        else
        {
            currentDate = currentDate.AddDays(-7);
        }
        StateHasChanged();
    }

    private void GoToday()
    {
        currentDate = DateTime.Today;
        StateHasChanged();
    }

    private void GoNext()
    {
        if (currentView == "Month")
        {
            currentDate = currentDate.AddMonths(1);
        }
        else
        {
            currentDate = currentDate.AddDays(7);
        }
        StateHasChanged();
    }

    private DateTime GetWeekStart()
    {
        var diff = (7 + (currentDate.DayOfWeek - DayOfWeek.Monday)) % 7;
        return currentDate.AddDays(-1 * diff).Date;
    }

    private void OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<ScheduleAppointmentData> args)
    {
        if (args.Data != null)
        {
            EditSchedule(args.Data.ScheduleId);
        }
    }

    private void OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        // Navigate to create page with pre-selected date
        NavigationManager.NavigateTo($"/admin/schedule/create?date={args.Start:yyyy-MM-dd}");
    }

    private void CreateSchedule()
    {
        NavigationManager.NavigateTo("/admin/schedule/create");
    }

    private void EditSchedule(int scheduleId)
    {
        NavigationManager.NavigateTo($"/admin/schedule/edit/{scheduleId}");
    }

    private string GetScheduleCardClass(HMS.Models.Schedule schedule)
    {
        return schedule.Status switch
        {
            "Active" => "bg-success bg-opacity-25",
            "Scheduled" => "bg-primary bg-opacity-25",
            "Completed" => "bg-secondary bg-opacity-25",
            "Cancelled" => "bg-danger bg-opacity-25",
            _ => "bg-light"
        };
    }

    private string GetStatusColor(string status) => status switch
    {
        "Scheduled" => "primary",
        "Active" => "success",
        "Completed" => "secondary",
        "Cancelled" => "danger",
        _ => "secondary"
    };

    private string GetShiftTypeColor(string shiftType) => shiftType switch
    {
        "Morning" => "warning",
        "Afternoon" => "info",
        "Evening" => "primary",
        "Night" => "dark",
        "Full Day" => "success",
        "On-Call" => "danger",
        _ => "secondary"
    };

    // Data model for Radzen Scheduler
    public class ScheduleAppointmentData
    {
        public int ScheduleId { get; set; }
        public DateTime Start { get; set; }
        public DateTime End { get; set; }
        public string Text { get; set; } = "";
        public int StaffId { get; set; }
        public string ShiftType { get; set; } = "";
        public string Status { get; set; } = "";
        public bool IsAvailable { get; set; }
    }
}
