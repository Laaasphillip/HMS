@page "/admin/schedule/edit/{ScheduleId:int}"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@using System.ComponentModel.DataAnnotations

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header text-white" style="background-color: #877BAF;">
                    <h4 class="mb-0">
                        <i class="bi bi-pencil-square me-2"></i>
                        Edit Schedule #@ScheduleId
                    </h4>
                </div>
                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border" style="color: #877BAF;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <EditForm Model="@schedule" OnValidSubmit="HandleSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger mb-3" />

                            <div class="row">
                                <!-- Schedule ID (Read-only) -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Schedule ID</label>
                                    <input type="text" class="form-control" value="@schedule.ScheduleId" disabled />
                                </div>

                                <!-- Staff Selection -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Staff Member *</label>
                                    <InputSelect @bind-Value="schedule.StaffId" class="form-select">
                                        <option value="0">Select Staff</option>
                                        @foreach (var staff in staffList)
                                        {
                                            <option value="@staff.StaffId">@staff.FullName (@staff.Role)</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => schedule.StaffId)" />
                                </div>

                                <!-- Schedule Date -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Schedule Date *</label>
                                    <InputDate @bind-Value="schedule.ScheduleDate" class="form-control" />
                                    <ValidationMessage For="@(() => schedule.ScheduleDate)" />
                                </div>

                                <!-- Status -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Status *</label>
                                    <InputSelect @bind-Value="schedule.Status" class="form-select">
                                        <option value="Available">Available</option>
                                        <option value="Booked">Booked</option>
                                        <option value="Blocked">Blocked</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => schedule.Status)" />
                                </div>

                                <!-- Start Time -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Start Time *</label>
                                    <input type="time"
                                           value="@schedule.StartTime.ToString(@"hh\:mm")"
                                           @onchange="@((ChangeEventArgs e) => schedule.StartTime = TimeSpan.Parse(e.Value.ToString()))" />
                                    <ValidationMessage For="@(() => schedule.StartTime)" />
                                </div>

                                <!-- End Time -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">End Time *</label>
                                    <input type="time"
                                           value="@schedule.EndTime.ToString(@"hh\:mm")"
                                           @onchange="@((ChangeEventArgs e) => schedule.EndTime = TimeSpan.Parse(e.Value.ToString()))" />
                                    <ValidationMessage For="@(() => schedule.EndTime)" />
                                </div>

                                <!-- Duration (Calculated, Read-only) -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Duration</label>
                                    <input type="text" class="form-control" value="@CalculateDuration() minutes" disabled />
                                </div>

                                <!-- Patient (if booked) -->
                                @if (schedule.Status == "Booked")
                                {
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Patient</label>
                                        <InputSelect @bind-Value="schedule.PatientId" class="form-select">
                                            <option value="0">No Patient</option>
                                            @foreach (var patient in patientList)
                                            {
                                                <option value="@patient.PatientId">@patient.FullName</option>
                                            }
                                        </InputSelect>
                                    </div>

                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Appointment Reason</label>
                                        <InputText @bind-Value="schedule.AppointmentReason" class="form-control" placeholder="Reason for appointment" />
                                    </div>
                                }

                                <!-- Notes -->
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Notes</label>
                                    <InputTextArea @bind-Value="schedule.Notes" class="form-control" rows="3" placeholder="Any additional notes..." />
                                </div>

                                <!-- Created At (Read-only) -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Created At</label>
                                    <input type="text" class="form-control" value="@schedule.CreatedAt.ToString("yyyy-MM-dd HH:mm")" disabled />
                                </div>

                                <!-- Last Updated (Read-only) -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Last Updated</label>
                                    <input type="text" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd HH:mm")" disabled />
                                </div>
                            </div>

                            <!-- Status Alert -->
                            @if (schedule.Status == "Booked" && schedule.PatientId == 0)
                            {
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Status is marked as "Booked" but no patient is assigned.
                                </div>
                            }

                            <!-- Action Buttons -->
                            <div class="d-flex gap-2 mt-4">
                                <button type="submit" class="btn text-white" style="background-color: #877BAF;">
                                    <i class="bi bi-check-circle me-1"></i> Update Schedule
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                                    <i class="bi bi-x-circle me-1"></i> Cancel
                                </button>
                                @if (schedule.Status == "Available")
                                {
                                    <button type="button" class="btn btn-success ms-auto" @onclick="BookAppointment">
                                        <i class="bi bi-calendar-check me-1"></i> Book Appointment
                                    </button>
                                }
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int ScheduleId { get; set; }

    public class StaffSummary
    {
        public int StaffId { get; set; }
        public string FullName { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
    }

    public class PatientSummary
    {
        public int PatientId { get; set; }
        public string FullName { get; set; } = string.Empty;
    }

    private ScheduleEditModel schedule = new();
    private List<StaffSummary> staffList = new();
    private List<PatientSummary> patientList = new();
    private bool isLoading = true;

    protected override void OnInitialized()
    {
        LoadStaffList();
        LoadPatientList();
        LoadScheduleData();
        isLoading = false;
    }

    private void LoadStaffList()
    {
        staffList = new List<StaffSummary>
        {
            new StaffSummary { StaffId = 2001, FullName = "Dr. Sarah Williams", Role = "Doctor" },
            new StaffSummary { StaffId = 2002, FullName = "Dr. James Peterson", Role = "Doctor" },
            new StaffSummary { StaffId = 2003, FullName = "Nurse Maria Karlsson", Role = "Nurse" },
            new StaffSummary { StaffId = 2004, FullName = "Dr. Henrik Olsson", Role = "Doctor" },
            new StaffSummary { StaffId = 2005, FullName = "Nurse Emma Nilsson", Role = "Nurse" }
        };
    }

    private void LoadPatientList()
    {
        patientList = new List<PatientSummary>
        {
            new PatientSummary { PatientId = 1001, FullName = "Emma Johnson" },
            new PatientSummary { PatientId = 1002, FullName = "Michael Anderson" },
            new PatientSummary { PatientId = 1003, FullName = "Sofia Bergström" },
            new PatientSummary { PatientId = 1004, FullName = "Lars Svensson" },
            new PatientSummary { PatientId = 1005, FullName = "Anna Lindqvist" }
        };
    }

    private void LoadScheduleData()
    {
        // In real app, fetch from database
        schedule = ScheduleId switch
        {
            1 => new ScheduleEditModel
            {
                ScheduleId = 1,
                StaffId = 2001,
                ScheduleDate = DateTime.Today,
                StartTime = new TimeSpan(9, 0, 0),
                EndTime = new TimeSpan(10, 0, 0),
                Status = "Booked",
                PatientId = 1001,
                AppointmentReason = "Regular Checkup",
                CreatedAt = DateTime.Today.AddDays(-7)
            },
            2 => new ScheduleEditModel
            {
                ScheduleId = 2,
                StaffId = 2001,
                ScheduleDate = DateTime.Today,
                StartTime = new TimeSpan(10, 0, 0),
                EndTime = new TimeSpan(11, 0, 0),
                Status = "Available",
                CreatedAt = DateTime.Today.AddDays(-7)
            },
            _ => new ScheduleEditModel
            {
                ScheduleId = ScheduleId,
                StaffId = 2001,
                ScheduleDate = DateTime.Today,
                StartTime = new TimeSpan(9, 0, 0),
                EndTime = new TimeSpan(10, 0, 0),
                Status = "Available",
                CreatedAt = DateTime.Today
            }
        };
    }

    private int CalculateDuration()
    {
        return (int)(schedule.EndTime - schedule.StartTime).TotalMinutes;
    }

    private void HandleSubmit()
    {
        // In real app, save to database
        Navigation.NavigateTo("/Admin/Schedule");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/Admin/Schedule");
    }

    private void BookAppointment()
    {
        Navigation.NavigateTo($"/admin/appointment/create?scheduleId={ScheduleId}");
    }

    public class ScheduleEditModel
    {
        public int ScheduleId { get; set; }

        [Required(ErrorMessage = "Staff member is required")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a staff member")]
        public int StaffId { get; set; }

        [Required(ErrorMessage = "Schedule date is required")]
        [DataType(DataType.Date)]
        public DateTime ScheduleDate { get; set; }

        [Required(ErrorMessage = "Start time is required")]
        public TimeSpan StartTime { get; set; }

        [Required(ErrorMessage = "End time is required")]
        public TimeSpan EndTime { get; set; }

        [Required(ErrorMessage = "Status is required")]
        public string Status { get; set; } = string.Empty;

        public int PatientId { get; set; }

        [StringLength(200, ErrorMessage = "Appointment reason cannot exceed 200 characters")]
        public string? AppointmentReason { get; set; }

        [StringLength(500, ErrorMessage = "Notes cannot exceed 500 characters")]
        public string? Notes { get; set; }

        public DateTime CreatedAt { get; set; }
    }
}