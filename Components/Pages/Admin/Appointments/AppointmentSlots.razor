@page "/appointment-slots"
@using HMS.Models
@using HMS.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "AdminOrStaff")]
@inject AdminService AdminService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Appointment Slots Management</PageTitle>

<style>
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1050;
    }
</style>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">
                <i class="bi bi-calendar-range me-2 text-primary"></i>Appointment Slots
            </h1>
            <p class="text-muted mb-0">Manage appointment slots for staff schedules</p>
        </div>
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            <i class="bi bi-plus-circle me-2"></i>Create Slot
        </button>
    </div>

    <!-- Alerts -->
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>@successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading appointment slots...</p>
        </div>
    }
    else
    {
        <!-- Stats -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-lg-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="bg-success bg-opacity-10 text-success rounded-circle d-inline-flex align-items-center justify-content-center mb-2"
                             style="width: 48px; height: 48px;">
                            <i class="bi bi-check-circle fs-4"></i>
                        </div>
                        <h3 class="h4 fw-bold mb-0">@filteredSlots.Count(s => s.Status == "Available")</h3>
                        <p class="text-muted small mb-0">Available</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-2"
                             style="width: 48px; height: 48px;">
                            <i class="bi bi-calendar-check fs-4"></i>
                        </div>
                        <h3 class="h4 fw-bold mb-0">@filteredSlots.Count(s => s.Status == "Booked")</h3>
                        <p class="text-muted small mb-0">Booked</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="bg-warning bg-opacity-10 text-warning rounded-circle d-inline-flex align-items-center justify-content-center mb-2"
                             style="width: 48px; height: 48px;">
                            <i class="bi bi-lock fs-4"></i>
                        </div>
                        <h3 class="h4 fw-bold mb-0">@filteredSlots.Count(s => s.Status == "Blocked")</h3>
                        <p class="text-muted small mb-0">Blocked</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="bg-danger bg-opacity-10 text-danger rounded-circle d-inline-flex align-items-center justify-content-center mb-2"
                             style="width: 48px; height: 48px;">
                            <i class="bi bi-x-circle fs-4"></i>
                        </div>
                        <h3 class="h4 fw-bold mb-0">@filteredSlots.Count(s => s.Status == "Cancelled")</h3>
                        <p class="text-muted small mb-0">Cancelled</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-funnel me-2"></i>Filters
                    </h5>
                    @if (HasActiveFilters())
                    {
                        <button class="btn btn-outline-danger btn-sm" @onclick="ClearFilters">
                            <i class="bi bi-x-lg me-1"></i>Clear All
                        </button>
                    }
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold small text-muted">STAFF MEMBER</label>
                        <select class="form-select" @bind="selectedStaffId" @bind:after="ApplyFilters">
                            <option value="0">All Staff</option>
                            @foreach (var staff in allStaff)
                            {
                                <option value="@staff.Id">
                                    Dr. @staff.User?.FirstName @staff.User?.LastName
                                </option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold small text-muted">STATUS</label>
                        <select class="form-select" @bind="selectedStatus" @bind:after="ApplyFilters">
                            <option value="">All Statuses</option>
                            <option value="Available">Available</option>
                            <option value="Booked">Booked</option>
                            <option value="Blocked">Blocked</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold small text-muted">FROM DATE</label>
                        <input type="date" class="form-control" @bind="fromDate" @bind:after="ApplyFilters" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold small text-muted">TO DATE</label>
                        <input type="date" class="form-control" @bind="toDate" @bind:after="ApplyFilters" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-semibold">
                        Appointment Slots
                        <span class="badge bg-primary ms-2">@filteredSlots.Count</span>
                    </h5>
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-muted small">Show:</span>
                        <select class="form-select form-select-sm" style="width: auto;" @bind="pageSize" @bind:after="OnPageSizeChanged">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>

            @if (pagedSlots.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="fw-semibold text-muted small py-3">#</th>
                                <th class="fw-semibold text-muted small py-3">STAFF</th>
                                <th class="fw-semibold text-muted small py-3">DATE</th>
                                <th class="fw-semibold text-muted small py-3">TIME</th>
                                <th class="fw-semibold text-muted small py-3">DURATION</th>
                                <th class="fw-semibold text-muted small py-3">STATUS</th>
                                <th class="fw-semibold text-muted small py-3">BOOKINGS</th>
                                <th class="fw-semibold text-muted small py-3 text-end">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int sequenceNumber = (currentPage - 1) * pageSize + 1;
                            }
                            @foreach (var slot in pagedSlots)
                            {
                                <tr>
                                    <td class="py-3 text-muted">@sequenceNumber</td>
                                    <td class="py-3">
                                        <div class="fw-semibold">Dr. @slot.Staff?.User?.FirstName @slot.Staff?.User?.LastName</div>
                                        <small class="text-muted">@slot.Staff?.Department</small>
                                    </td>
                                    <td class="py-3">@slot.Date.ToString("MMM dd, yyyy")</td>
                                    <td class="py-3">
                                        <span class="fw-medium">@slot.StartTime.ToString(@"hh\:mm") - @slot.EndTime.ToString(@"hh\:mm")</span>
                                    </td>
                                    <td class="py-3">
                                        <span class="badge bg-light text-dark">@((slot.EndTime - slot.StartTime).TotalMinutes)m</span>
                                    </td>
                                    <td class="py-3">
                                        <span class="badge @GetStatusBadgeClass(slot.Status)">
                                            @slot.Status
                                        </span>
                                    </td>
                                    <td class="py-3">
                                        <span class="fw-medium">@slot.CurrentBookings / @slot.MaxCapacity</span>
                                    </td>
                                    <td class="py-3">
                                        <div class="d-flex gap-2 justify-content-end">
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowEditModal(slot)" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger"
                                                    @onclick="() => ShowDeleteConfirmation(slot)"
                                                    disabled="@(slot.CurrentBookings > 0)"
                                                    title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                sequenceNumber++;
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="card-footer bg-white border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">
                            Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, filteredSlots.Count) of @filteredSlots.Count entries
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="GoToFirstPage">
                                        <i class="bi bi-chevron-double-left"></i>
                                    </button>
                                </li>
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="GoToPreviousPage">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                </li>

                                @foreach (var pageNum in GetVisiblePages())
                                {
                                    if (pageNum == -1)
                                    {
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    }
                                    else
                                    {
                                        <li class="page-item @(pageNum == currentPage ? "active" : "")">
                                            <button class="page-link" @onclick="@(() => GoToPage(pageNum))">
                                                @pageNum
                                            </button>
                                        </li>
                                    }
                                }

                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="GoToNextPage">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </li>
                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="GoToLastPage">
                                        <i class="bi bi-chevron-double-right"></i>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            }
            else
            {
                <div class="card-body text-center py-5">
                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                         style="width: 80px; height: 80px;">
                        <i class="bi bi-calendar-x text-muted display-4"></i>
                    </div>
                    <h5 class="mb-2">No Appointment Slots</h5>
                    <p class="text-muted mb-4">No slots match your current filters</p>
                    @if (HasActiveFilters())
                    {
                        <button class="btn btn-outline-primary me-2" @onclick="ClearFilters">
                            <i class="bi bi-arrow-counterclockwise me-2"></i>Clear Filters
                        </button>
                    }
                    <button class="btn btn-primary" @onclick="ShowCreateModal">
                        <i class="bi bi-plus-circle me-2"></i>Create First Slot
                    </button>
                </div>
            }
        </div>
    }
</div>

<!-- Create/Edit Modal -->
@if (showModal)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-bottom">
                    <h5 class="modal-title fw-semibold">
                        <i class="bi bi-@(isEditMode ? "pencil" : "plus-circle") me-2 text-primary"></i>
                        @(isEditMode ? "Edit" : "Create") Appointment Slot
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>

                <div class="modal-body">
                    <EditForm Model="slotModel" OnValidSubmit="SaveSlot">
                        <DataAnnotationsValidator />

                        <!-- Staff Selection -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-person-badge me-1"></i>Staff Member *
                            </label>
                            <select class="form-select" @bind="slotModel.StaffId" disabled="@isEditMode">
                                <option value="0">-- Select Staff --</option>
                                @foreach (var staff in allStaff)
                                {
                                    <option value="@staff.Id">
                                        Dr. @staff.User?.FirstName @staff.User?.LastName - @staff.Department
                                    </option>
                                }
                            </select>
                            @if (slotModel.StaffId == 0)
                            {
                                <small class="text-danger">Please select a staff member</small>
                            }
                        </div>

                        <!-- Date -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-calendar me-1"></i>Date *
                            </label>
                            <input type="date" class="form-control" @bind="slotDate" />
                        </div>

                        <div class="row g-3 mb-3">
                            <!-- Start Time -->
                            <div class="col-6">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-clock me-1"></i>Start Time *
                                </label>
                                <input type="time" class="form-control"
                                       value="@startTime"
                                       @onchange="@((ChangeEventArgs e) => { startTime = e.Value?.ToString() ?? "09:00"; })" />
                            </div>

                            <!-- End Time -->
                            <div class="col-6">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-clock me-1"></i>End Time *
                                </label>
                                <input type="time" class="form-control"
                                       value="@endTime"
                                       @onchange="@((ChangeEventArgs e) => { endTime = e.Value?.ToString() ?? "10:00"; })" />
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <!-- Status -->
                            <div class="col-6">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-tag me-1"></i>Status *
                                </label>
                                <select class="form-select" @bind="slotModel.Status">
                                    <option value="Available">Available</option>
                                    <option value="Blocked">Blocked</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>

                            <!-- Max Capacity -->
                            <div class="col-6">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-people me-1"></i>Max Capacity *
                                </label>
                                <input type="number" class="form-control" @bind="slotModel.MaxCapacity" min="1" />
                            </div>
                        </div>

                        @if (isEditMode)
                        {
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Current Bookings:</strong> @slotModel.CurrentBookings / @slotModel.MaxCapacity
                                <small class="d-block mt-1">You cannot reduce max capacity below current bookings</small>
                            </div>
                        }

                        <div class="d-flex gap-2 justify-content-end">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">
                                <i class="bi bi-x-circle me-1"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@saving">
                                @if (saving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Saving...</span>
                                }
                                else
                                {
                                    <i class="bi bi-@(isEditMode ? "check-circle" : "plus-circle") me-1"></i>
                                    <span>@(isEditMode ? "Update" : "Create") Slot</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal && slotToDelete != null)
{
    <div class="modal-backdrop" @onclick="() => showDeleteModal = false"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-bottom">
                    <h5 class="modal-title fw-semibold">
                        <i class="bi bi-exclamation-triangle me-2 text-danger"></i>Confirm Delete
                    </h5>
                    <button type="button" class="btn-close" @onclick="() => showDeleteModal = false"></button>
                </div>

                <div class="modal-body">
                    <p class="mb-3">Are you sure you want to delete this appointment slot?</p>
                    <div class="p-3 bg-light rounded mb-3">
                        <div class="mb-2"><strong>Date:</strong> @slotToDelete.Date.ToString("MMMM dd, yyyy")</div>
                        <div class="mb-2"><strong>Time:</strong> @slotToDelete.StartTime.ToString("HH:mm") - @slotToDelete.EndTime.ToString("HH:mm")</div>
                        <div><strong>Staff:</strong> Dr. @slotToDelete.Staff?.User?.FirstName @slotToDelete.Staff?.User?.LastName</div>
                    </div>
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>This action cannot be undone.
                    </div>
                </div>

                <div class="modal-footer border-top">
                    <button type="button" class="btn btn-secondary" @onclick="() => showDeleteModal = false">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@deleting">
                        @if (deleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Deleting...</span>
                        }
                        else
                        {
                            <i class="bi bi-trash me-1"></i>
                            <span>Delete Slot</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<AppointmentSlot> allSlots = new();
    private List<AppointmentSlot> filteredSlots = new();
    private List<AppointmentSlot> pagedSlots = new();
    private List<Staff> allStaff = new();

    private int selectedStaffId = 0;
    private string selectedStatus = "";
    private DateTime? fromDate = null;
    private DateTime? toDate = null;

    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    private bool loading = true;
    private bool saving = false;
    private bool deleting = false;
    private bool showModal = false;
    private bool showDeleteModal = false;
    private bool isEditMode = false;
    private string? errorMessage;
    private string? successMessage;

    private AppointmentSlot? slotToDelete;
    private SlotEditModel slotModel = new();

    private DateTime slotDate = DateTime.Today;
    private string startTime = "09:00";
    private string endTime = "10:00";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            loading = true;
            errorMessage = null;

            allSlots = await AdminService.GetAllAppointmentSlotsAsync();
            allStaff = await AdminService.GetAllStaffAsync();

            ApplyFilters();
            UpdatePagination();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private void ApplyFilters()
    {
        filteredSlots = allSlots.ToList();

        if (selectedStaffId > 0)
            filteredSlots = filteredSlots.Where(s => s.StaffId == selectedStaffId).ToList();

        if (!string.IsNullOrEmpty(selectedStatus))
            filteredSlots = filteredSlots.Where(s => s.Status == selectedStatus).ToList();

        if (fromDate.HasValue)
            filteredSlots = filteredSlots.Where(s => s.Date >= fromDate.Value).ToList();

        if (toDate.HasValue)
            filteredSlots = filteredSlots.Where(s => s.Date <= toDate.Value).ToList();

        currentPage = 1;
        UpdatePagination();
    }

    private void UpdatePagination()
    {
        totalPages = (int)Math.Ceiling((double)filteredSlots.Count / pageSize);
        if (totalPages == 0) totalPages = 1;
        if (currentPage > totalPages) currentPage = totalPages;

        var skip = (currentPage - 1) * pageSize;
        pagedSlots = filteredSlots
            .OrderBy(s => s.Date)
            .ThenBy(s => s.StartTime)
            .Skip(skip)
            .Take(pageSize)
            .ToList();

        StateHasChanged();
    }

    private List<int> GetVisiblePages()
    {
        var pages = new List<int>();
        var maxVisiblePages = 5;

        if (totalPages <= maxVisiblePages)
        {
            for (int i = 1; i <= totalPages; i++)
                pages.Add(i);
        }
        else
        {
            if (currentPage <= 3)
            {
                for (int i = 1; i <= 4; i++)
                    pages.Add(i);
                pages.Add(-1);
                pages.Add(totalPages);
            }
            else if (currentPage >= totalPages - 2)
            {
                pages.Add(1);
                pages.Add(-1);
                for (int i = totalPages - 3; i <= totalPages; i++)
                    pages.Add(i);
            }
            else
            {
                pages.Add(1);
                pages.Add(-1);
                for (int i = currentPage - 1; i <= currentPage + 1; i++)
                    pages.Add(i);
                pages.Add(-1);
                pages.Add(totalPages);
            }
        }

        return pages;
    }

    private void GoToPage(int page) { currentPage = page; UpdatePagination(); }
    private void GoToFirstPage() { currentPage = 1; UpdatePagination(); }
    private void GoToPreviousPage() { if (currentPage > 1) { currentPage--; UpdatePagination(); } }
    private void GoToNextPage() { if (currentPage < totalPages) { currentPage++; UpdatePagination(); } }
    private void GoToLastPage() { currentPage = totalPages; UpdatePagination(); }
    private void OnPageSizeChanged() { currentPage = 1; UpdatePagination(); }

    private bool HasActiveFilters() =>
        selectedStaffId > 0 || !string.IsNullOrEmpty(selectedStatus) || fromDate.HasValue || toDate.HasValue;

    private void ClearFilters()
    {
        selectedStaffId = 0;
        selectedStatus = "";
        fromDate = null;
        toDate = null;
        ApplyFilters();
    }

    private void ShowCreateModal()
    {
        isEditMode = false;
        slotModel = new SlotEditModel { StaffId = 0, Status = "Available", MaxCapacity = 1, CurrentBookings = 0 };
        slotDate = DateTime.Today;
        startTime = "09:00";
        endTime = "10:00";
        showModal = true;
    }

    private void ShowEditModal(AppointmentSlot slot)
    {
        isEditMode = true;
        slotModel = new SlotEditModel
        {
            Id = slot.Id,
            StaffId = slot.StaffId,
            Status = slot.Status ?? "Available",
            MaxCapacity = slot.MaxCapacity,
            CurrentBookings = slot.CurrentBookings
        };
        slotDate = slot.Date;
        startTime = slot.StartTime.ToString(@"hh\:mm");
        endTime = slot.EndTime.ToString(@"hh\:mm");
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        slotModel = new();
    }

    private async Task SaveSlot()
    {
        try
        {
            saving = true;
            errorMessage = null;

            if (slotModel.StaffId == 0)
            {
                errorMessage = "Please select a staff member";
                saving = false;
                return;
            }

            if (!TimeSpan.TryParse(startTime, out var startTimeSpan))
            {
                errorMessage = "Invalid start time format";
                saving = false;
                return;
            }

            if (!TimeSpan.TryParse(endTime, out var endTimeSpan))
            {
                errorMessage = "Invalid end time format";
                saving = false;
                return;
            }

            if (endTimeSpan <= startTimeSpan)
            {
                errorMessage = "End time must be after start time";
                saving = false;
                return;
            }

            if (isEditMode)
            {
                var existingSlot = await AdminService.GetAppointmentSlotByIdAsync(slotModel.Id);
                if (existingSlot == null)
                {
                    errorMessage = "Slot not found";
                    saving = false;
                    return;
                }

                if (slotModel.MaxCapacity < existingSlot.CurrentBookings)
                {
                    errorMessage = $"Max capacity cannot be less than current bookings ({existingSlot.CurrentBookings})";
                    saving = false;
                    return;
                }

                existingSlot.Date = slotDate.Date;
                existingSlot.StartTime = startTimeSpan;
                existingSlot.EndTime = endTimeSpan;
                existingSlot.Status = slotModel.Status;
                existingSlot.MaxCapacity = slotModel.MaxCapacity;

                await AdminService.UpdateAppointmentSlotAsync(existingSlot);
                successMessage = "Appointment slot updated successfully";
            }
            else
            {
                var newSlot = new AppointmentSlot
                {
                    StaffId = slotModel.StaffId,
                    Date = slotDate.Date,
                    StartTime = startTimeSpan,
                    EndTime = endTimeSpan,
                    Status = slotModel.Status,
                    MaxCapacity = slotModel.MaxCapacity,
                    CurrentBookings = 0
                };

                await AdminService.CreateAppointmentSlotAsync(newSlot);
                successMessage = "Appointment slot created successfully";
            }

            CloseModal();
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving slot: {ex.Message}";
        }
        finally
        {
            saving = false;
        }
    }

    private void ShowDeleteConfirmation(AppointmentSlot slot)
    {
        slotToDelete = slot;
        showDeleteModal = true;
    }

    private async Task ConfirmDelete()
    {
        if (slotToDelete == null) return;

        try
        {
            deleting = true;
            errorMessage = null;

            await AdminService.DeleteAppointmentSlotAsync(slotToDelete.Id);
            successMessage = "Appointment slot deleted successfully";
            showDeleteModal = false;
            slotToDelete = null;
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting slot: {ex.Message}";
        }
        finally
        {
            deleting = false;
        }
    }

    private string GetStatusBadgeClass(string? status) => status?.ToLower() switch
    {
        "available" => "bg-success bg-opacity-10 text-success",
        "booked" => "bg-secondary bg-opacity-10 text-secondary",
        "blocked" => "bg-warning bg-opacity-10 text-warning",
        "cancelled" => "bg-danger bg-opacity-10 text-danger",
        _ => "bg-light text-dark"
    };

    private class SlotEditModel
    {
        public int Id { get; set; }
        public int StaffId { get; set; }
        public string Status { get; set; } = "Available";
        public int MaxCapacity { get; set; } = 1;
        public int CurrentBookings { get; set; } = 0;
    }
}