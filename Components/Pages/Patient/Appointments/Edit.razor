@* @page "/admin/schedule/edit/{ScheduleId:int}"
@using HMS.Models
@using HMS.Services
@using System.ComponentModel.DataAnnotations
@inject AdminService AdminService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header text-white" style="background-color: #877BAF;">
                    <h4 class="mb-0">
                        <i class="bi bi-pencil-square me-2"></i>
                        Edit Schedule #@ScheduleId
                    </h4>
                </div>
                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border" style="color: #877BAF;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            @errorMessage
                        </div>
                        <button class="btn btn-secondary" @onclick="Cancel">
                            <i class="bi bi-arrow-left me-1"></i> Back to List
                        </button>
                    }
                    else
                    {
                        <EditForm Model="@schedule" OnValidSubmit="HandleSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger mb-3" />

                            <div class="row">
                                <!-- Schedule ID (Read-only) -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Schedule ID</label>
                                    <input type="text" class="form-control" value="@ScheduleId" disabled />
                                </div>

                                <!-- Staff Selection -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Staff Member *</label>
                                    <InputSelect @bind-Value="schedule.StaffId" class="form-select">
                                        <option value="0">Select Staff</option>
                                        @foreach (var staff in staffList)
                                        {
                                            <option value="@staff.Id">@staff.FullName (@staff.Role)</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => schedule.StaffId)" />
                                </div>

                                <!-- Schedule Date -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Schedule Date *</label>
                                    <InputDate @bind-Value="schedule.ScheduleDate" class="form-control" />
                                    <ValidationMessage For="@(() => schedule.ScheduleDate)" />
                                </div>

                                <!-- Shift Type -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Shift Type</label>
                                    <InputSelect @bind-Value="schedule.ShiftType" class="form-select">
                                        <option value="">Select Shift Type</option>
                                        <option value="Morning">Morning</option>
                                        <option value="Afternoon">Afternoon</option>
                                        <option value="Evening">Evening</option>
                                        <option value="Night">Night</option>
                                        <option value="Full Day">Full Day</option>
                                    </InputSelect>
                                </div>

                                <!-- Start Time -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Start Time *</label>
                                    <input type="time"
                                           class="form-control"
                                           value="@schedule.StartTime.ToString(@"HH\:mm")"
                                           @onchange="@((ChangeEventArgs e) => schedule.StartTime = TimeSpan.Parse(e.Value.ToString()))" />
                                    <ValidationMessage For="@(() => schedule.StartTime)" />
                                </div>

                                <!-- End Time -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">End Time *</label>
                                    <input type="time"
                                           class="form-control"
                                           value="@schedule.EndTime.ToString(@"HH\:mm")"
                                           @onchange="@((ChangeEventArgs e) => schedule.EndTime = TimeSpan.Parse(e.Value.ToString()))" />
                                    <ValidationMessage For="@(() => schedule.EndTime)" />
                                </div>

                                <!-- Break Start Time -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Break Start Time</label>
                                    <input type="time"
                                           class="form-control"
                                           value="@schedule.BreakStartTime.ToString(@"HH\:mm")"
                                           @onchange="@((ChangeEventArgs e) => schedule.BreakStartTime = TimeSpan.Parse(e.Value.ToString()))" />
                                </div>

                                <!-- Break End Time -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Break End Time</label>
                                    <input type="time"
                                           class="form-control"
                                           value="@schedule.BreakEndTime.ToString(@"HH\:mm")"
                                           @onchange="@((ChangeEventArgs e) => schedule.BreakEndTime = TimeSpan.Parse(e.Value.ToString()))" />
                                </div>

                                <!-- Status -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Status *</label>
                                    <InputSelect @bind-Value="schedule.Status" class="form-select">
                                        <option value="">Select Status</option>
                                        <option value="Available">Available</option>
                                        <option value="Booked">Booked</option>
                                        <option value="Blocked">Blocked</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => schedule.Status)" />
                                </div>

                                <!-- Is Available -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Availability</label>
                                    <div class="form-check mt-2">
                                        <InputCheckbox @bind-Value="schedule.IsAvailable" class="form-check-input" id="isAvailable" />
                                        <label class="form-check-label" for="isAvailable">
                                            Mark as available for appointments
                                        </label>
                                    </div>
                                </div>

                                <!-- Duration (Calculated, Read-only) -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Duration</label>
                                    <input type="text" class="form-control" value="@CalculateDuration() hours" disabled />
                                </div>

                                <!-- Created At (Read-only) -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Created At</label>
                                    <input type="text" class="form-control" value="@schedule.CreatedAt.ToString("yyyy-MM-dd HH:mm")" disabled />
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-2 mt-4">
                                <button type="submit" class="btn text-white" style="background-color: #877BAF;">
                                    <i class="bi bi-check-circle me-1"></i> Update Schedule
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                                    <i class="bi bi-x-circle me-1"></i> Cancel
                                </button>
                                <button type="button" class="btn btn-info ms-auto" @onclick="ViewDetails">
                                    <i class="bi bi-eye me-1"></i> View Details
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int ScheduleId { get; set; }

    public class StaffSummary
    {
        public int Id { get; set; }
        public string FullName { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
    }

    private ScheduleEditModel schedule = new();
    private List<StaffSummary> staffList = new();
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadStaffListAsync();
        await LoadScheduleDataAsync();
    }

    private async Task LoadStaffListAsync()
    {
        try
        {
            var staffMembers = await AdminService.GetAllStaffAsync();
            staffList = staffMembers.Select(s => new StaffSummary
            {
                Id = s.Id,
                FullName = s.User != null ? $"{s.User.FirstName} {s.User.LastName}".Trim() : "N/A",
                Role = s.User?.Role ?? "N/A"
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading staff list: {ex.Message}");
            staffList = new List<StaffSummary>();
        }
    }

    private async Task LoadScheduleDataAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var dbSchedule = await AdminService.GetScheduleByIdAsync(ScheduleId);

            if (dbSchedule == null)
            {
                errorMessage = "Schedule not found";
                schedule = new ScheduleEditModel();
                return;
            }

            // Map database model to edit model
            schedule = new ScheduleEditModel
            {
                Id = dbSchedule.Id,
                StaffId = dbSchedule.StaffId,
                ScheduleDate = dbSchedule.StartTime.Date,
                StartTime = dbSchedule.StartTime.TimeOfDay,
                EndTime = dbSchedule.EndTime.TimeOfDay,
                BreakStartTime = dbSchedule.BreakStart.TimeOfDay,
                BreakEndTime = dbSchedule.BreakEnd.TimeOfDay,
                ShiftType = dbSchedule.ShiftType ?? "",
                Status = dbSchedule.Status ?? "Available",
                IsAvailable = dbSchedule.IsAvailable,
                CreatedAt = dbSchedule.CreatedAt
            };
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading schedule: {ex.Message}";
            Console.WriteLine($"Error in LoadScheduleDataAsync: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            // Load the existing schedule from database
            var dbSchedule = await AdminService.GetScheduleByIdAsync(ScheduleId);

            if (dbSchedule == null)
            {
                errorMessage = "Schedule not found";
                return;
            }

            // Update schedule properties
            dbSchedule.StaffId = schedule.StaffId;
            dbSchedule.StartTime = schedule.ScheduleDate.Add(schedule.StartTime);
            dbSchedule.EndTime = schedule.ScheduleDate.Add(schedule.EndTime);
            dbSchedule.BreakStart = schedule.ScheduleDate.Add(schedule.BreakStartTime);
            dbSchedule.BreakEnd = schedule.ScheduleDate.Add(schedule.BreakEndTime);
            dbSchedule.ShiftType = schedule.ShiftType;
            dbSchedule.Status = schedule.Status;
            dbSchedule.IsAvailable = schedule.IsAvailable;

            var success = await AdminService.UpdateScheduleAsync(dbSchedule);

            if (success)
            {
                Navigation.NavigateTo("/Admin/Schedule");
            }
            else
            {
                errorMessage = "Failed to update schedule";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving schedule: {ex.Message}";
            Console.WriteLine($"Error in HandleSubmit: {ex}");
        }
    }

    private double CalculateDuration()
    {
        return (schedule.EndTime - schedule.StartTime).TotalHours;
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/Admin/Schedule");
    }

    private void ViewDetails()
    {
        Navigation.NavigateTo($"/admin/schedule/details/{ScheduleId}");
    }

    public class ScheduleEditModel
    {
        public int Id { get; set; }

        [Required(ErrorMessage = "Staff member is required")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a staff member")]
        public int StaffId { get; set; }

        [Required(ErrorMessage = "Schedule date is required")]
        [DataType(DataType.Date)]
        public DateTime ScheduleDate { get; set; }

        [Required(ErrorMessage = "Start time is required")]
        public TimeSpan StartTime { get; set; }

        [Required(ErrorMessage = "End time is required")]
        public TimeSpan EndTime { get; set; }

        public TimeSpan BreakStartTime { get; set; }

        public TimeSpan BreakEndTime { get; set; }

        public string ShiftType { get; set; } = string.Empty;

        [Required(ErrorMessage = "Status is required")]
        public string Status { get; set; } = string.Empty;

        public bool IsAvailable { get; set; }

        public DateTime CreatedAt { get; set; }
    }
} *@
