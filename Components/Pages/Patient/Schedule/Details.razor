@page "/patient/schedule/details/{ScheduleId:int}"
@using HMS.Models
@using HMS.Services
@inject PatientService PatientService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="container mt-4">
    <div class="card">
        <div class="card-header text-white" style="background-color: #877BAF;">
            <h4 class="mb-0"><i class="bi bi-calendar-check me-2"></i> Doctor Schedule</h4>
        </div>

        <div class="card-body">
            @if (isLoading)
            {
                <div class="text-center p-4">
                    <div class="spinner-border" style="color:#877BAF" role="status"></div>
                </div>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }
            else if (schedule != null)
            {
                <h5>@schedule.Staff?.User?.FirstName @schedule.Staff?.User?.LastName</h5>
                <p><i class="bi bi-calendar3"></i> @schedule.StartTime.ToString("dddd, MMMM dd, yyyy")</p>
                <p><i class="bi bi-clock"></i> @schedule.StartTime:HH:mm - @schedule.EndTime:HH:mm</p>

                <div class="mt-3">
                    @if (schedule.IsAvailable)
                    {
                        <button class="btn btn-success" @onclick="BookAppointment">
                            <i class="bi bi-check-circle me-1"></i> Book Appointment
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-secondary" disabled>
                            <i class="bi bi-x-circle me-1"></i> Not Available
                        </button>
                    }
                    <button class="btn btn-outline-secondary ms-2" @onclick="BackToList">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public int ScheduleId { get; set; }
    private Schedule? schedule;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadScheduleAsync();
    }

    private async Task LoadScheduleAsync()
    {
        try
        {
            schedule = await PatientService.GetScheduleByIdAsync(ScheduleId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading schedule: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task BookAppointment()
    {
        // Get the logged-in user’s PatientId
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;

        if (userId == null)
        {
            errorMessage = "User not logged in.";
            return;
        }

        // Find the corresponding patient
        var patient = await PatientService.GetPatientProfileAsync(userId);
        if (patient == null)
        {
            errorMessage = "Patient profile not found.";
            return;
        }

        var result = await PatientService.BookAppointmentAsync(ScheduleId, patient.Id);
        if (result.Success)
        {
            Navigation.NavigateTo("/patient/appointments");
        }
        else
        {
            errorMessage = result.Message;
        }
    }

    private void BackToList()
    {
        Navigation.NavigateTo("/patient/schedule");
    }
}
