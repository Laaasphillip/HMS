@page "/patient/schedule/book/{scheduleId:int}"
@using HMS.Models
@using HMS.Services
@inject PatientService PatientService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3><i class="bi bi-calendar-check"></i> Confirm Appointment</h3>

@if (isLoading)
{
    <div class="text-center p-3">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>
}
else if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert @statusCss">@statusMessage</div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else if (schedule == null)
{
    <p>Schedule not found.</p>
}
else
{
    <div class="card shadow-sm mt-3">
        <div class="card-body">
            <h5 class="mb-3">Appointment Details</h5>
            <p><strong>Doctor:</strong> @doctorName</p>
            <p><strong>Date:</strong> @schedule.StartTime.ToString("dddd, MMM dd yyyy")</p>
            <p><strong>Time:</strong> @schedule.StartTime.ToString("HH:mm") - @schedule.EndTime.ToString("HH:mm")</p>
            <p><strong>Status:</strong> @schedule.Status</p>

            @if (schedule.IsAvailable && (schedule.Status?.ToLower() ?? "") != "booked")
            {
                <button class="btn btn-success me-2" @onclick="ConfirmBooking" disabled="@isBooking">
                    @if (isBooking)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    }
                    Confirm Booking
                </button>
            }
            else
            {
                <button class="btn btn-secondary me-2" disabled>Not Available</button>
            }

            <button class="btn btn-secondary" @onclick="CancelBooking" disabled="@isBooking">Cancel</button>
        </div>
    </div>
}

@code {
    [Parameter] public int scheduleId { get; set; }

    private Schedule? schedule;
    private string doctorName = "";
    private bool isLoading = true;
    private bool isBooking = false;
    private string? statusMessage;
    private string statusCss = "alert-success";
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        errorMessage = null;
        statusMessage = null;

        try
        {
            schedule = await PatientService.GetScheduleByIdAsync(scheduleId);

            if (schedule != null && schedule.Staff?.User != null)
            {
                doctorName = $"{schedule.Staff.User.FirstName} {schedule.Staff.User.LastName}";
            }
            else if (schedule == null)
            {
                errorMessage = "Schedule not found.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading schedule: {ex.Message}";
            Console.WriteLine(ex);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ConfirmBooking()
    {
        if (schedule == null)
            return;

        isBooking = true;
        statusMessage = null;
        errorMessage = null;

        try
        {
            // 1) get current authenticated user id
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user?.Identity?.IsAuthenticated != true)
            {
                errorMessage = "You must be logged in to book an appointment.";
                return;
            }

            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "Unable to determine logged in user id.";
                return;
            }

            // 2) get patient record for this user
            var patient = await PatientService.GetPatientProfileAsync(userId);
            if (patient == null)
            {
                errorMessage = "No patient profile found for the current user.";
                return;
            }

            // 3) call your booking method (this is the method you already have)
            var (success, message) = await PatientService.BookScheduleAsync(schedule.Id, patient.Id);

            if (success)
            {
                statusMessage = message ?? "Booking confirmed.";
                statusCss = "alert-success";
                // optional: reload schedule to reflect booking
                schedule = await PatientService.GetScheduleByIdAsync(scheduleId);
                // navigate back or to a success page after a short pause (optional)
                Navigation.NavigateTo("/patient/schedule", forceLoad: true);
            }
            else
            {
                statusMessage = message ?? "Failed to book appointment.";
                statusCss = "alert-warning";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error booking appointment: {ex.Message}";
            Console.WriteLine(ex);
        }
        finally
        {
            isBooking = false;
        }
    }

    private void CancelBooking()
    {
        Navigation.NavigateTo("/patient/schedule");
    }
}
