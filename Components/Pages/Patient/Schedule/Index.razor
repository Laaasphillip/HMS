@page "/patient/schedule"
@using HMS.Models
@using HMS.Services
@inject PatientService PatientService
@inject NavigationManager Navigation
@using Radzen
@using Radzen.Blazor
@rendermode InteractiveServer

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="bi bi-calendar3 me-2"></i>
            Staff Schedule Calendar
        </h2>
    </div>

    <!-- Filters -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="row align-items-center g-2">
                <div class="col-md-3">
                    <label class="form-label mb-1 small">Filter Staff</label>
                    <select class="form-select form-select-sm" @bind="selectedStaffId" @bind:after="FilterSchedules">
                        <option value="0">All Staff</option>
                        @foreach (var staff in staffList)
                        {
                            <option value="@staff.Value">@staff.Text</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label mb-1 small">Filter Status</label>
                    <select class="form-select form-select-sm" @bind="selectedStatus" @bind:after="FilterSchedules">
                        <option value="">All Statuses</option>
                        <option value="Available">Available</option>
                        <option value="Booked">Booked</option>
                        <option value="Blocked">Blocked</option>
                    </select>
                </div>
                <div class="col-md-5 text-end">
                    <label class="form-label mb-1 small">Statistics</label>
                    <div class="d-flex gap-2 justify-content-end">
                        <span class="badge" style="background-color: #877BAF;">Available: @allSchedules.Count(s => s.Status == "Available")</span>
                        <span class="badge bg-success">Booked: @allSchedules.Count(s => s.Status == "Booked")</span>
                        <span class="badge bg-warning text-dark">Blocked: @allSchedules.Count(s => s.Status == "Blocked")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Universal Navigation Bar -->
    <div class="card mb-2">
        <div class="card-body py-2">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" @onclick="NavigatePrevious">
                            <i class="bi bi-chevron-left"></i> Previous
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="NavigateToday">
                            Today
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="NavigateNext">
                            Next <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <h5 class="mb-0">@GetCurrentPeriodTitle()</h5>
                </div>
                <div class="col-md-4 text-end">
                    <!-- View Switcher Buttons -->
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm @(selectedView == 0 && !showCustomTimeline ? "text-white" : "btn-outline-secondary")"
                                style="@(selectedView == 0 && !showCustomTimeline ? "background-color: #877BAF;" : "")"
                                @onclick='() => SwitchToView(0)'>
                            <i class="bi bi-calendar-month me-1"></i> Month
                        </button>
                        <button class="btn btn-sm @(showCustomTimeline ? "text-white" : "btn-outline-secondary")"
                                style="@(showCustomTimeline ? "background-color: #877BAF;" : "")"
                                @onclick='() => SwitchToView(1)'>
                            <i class="bi bi-list-task me-1"></i> Timeline
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Views -->
    @if (showCustomTimeline)
    {
        <!-- Custom Timeline View -->
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead>
                            <tr>
                                <th style="width: 200px; background-color: #f8f9fa;">Staff Member</th>
                                @for (int i = 0; i < 7; i++)
                                {
                                    var date = GetTimelineWeekStart().AddDays(i);
                                    var isToday = date.Date == DateTime.Today;
                                    <th class="text-center @(isToday ? "table-warning" : "")" style="min-width: 150px;">
                                        <div><strong>@date.ToString("ddd")</strong></div>
                                        <div class="small">@date.ToString("MMM dd")</div>
                                    </th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var staff in staffList.Where(s => s.Value != 0))
                            {
                                <tr style="height: 80px;">
                                    <td class="align-middle" style="background-color: #f8f9fa;">
                                        <div><strong>@GetStaffNameOnly(staff.Text)</strong></div>
                                        <small class="text-muted">@GetStaffRole(staff.Text)</small>
                                    </td>
                                    @for (int i = 0; i < 7; i++)
                                    {
                                        var date = GetTimelineWeekStart().AddDays(i);
                                        var daySchedules = filteredSchedules
                                        .Where(s => s.StaffId == staff.Value && s.Start.Date == date.Date)
                                        .OrderBy(s => s.Start)
                                        .ToList();

                                        <td class="p-2" style="cursor: pointer; vertical-align: top;"
                                            @onclick="() => OnDayClick(date, staff.Value)">
                                            @foreach (var schedule in daySchedules)
                                            {
                                                <div class="timeline-event mb-1 @GetStatusClass(schedule.Status)"
                                                     @onclick="() => OnAppointmentClick(schedule.ScheduleId)"
                                                     @onclick:stopPropagation="true"
                                                     title="@GetTooltip(schedule)">
                                                    <div class="small">
                                                        <strong>@schedule.Start.ToString("HH:mm") - @schedule.End.ToString("HH:mm")</strong>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(schedule.PatientName))
                                                    {
                                                        <div class="small">
                                                            <i class="bi bi-person-fill"></i> @schedule.PatientName
                                                        </div>
                                                    }
                                                    <div class="small">@schedule.Status</div>
                                                </div>
                                            }
                                            @if (!daySchedules.Any())
                                            {
                                                <div class="text-muted text-center small">No schedule</div>
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Radzen Scheduler -->
        <div class="card">
            <div class="card-body p-2">
                <RadzenScheduler @key="@schedulerKey"
                                 @ref="scheduler"
                                 TItem="AppointmentData"
                                 Data="@filteredSchedules"
                                 ShowHeader="false"
                                 StartProperty="Start"
                                 EndProperty="End"
                                 TextProperty="Text"
                                 SelectedIndex="@selectedView"
                                 SlotSelect="@OnSlotSelect"
                                 AppointmentSelect="@OnAppointmentSelect"
                                 AppointmentRender="@OnAppointmentRender"
                                 SlotRender="@OnSlotRender"
                                 LoadData="@OnLoadData"
                                 @bind-CurrentDate="@currentNavDate">

                    <RadzenMonthView />
                </RadzenScheduler>
            </div>
        </div>
    }

    <!-- Legend -->
    <div class="card mt-3">
        <div class="card-body py-2">
            <div class="d-flex gap-4 justify-content-center align-items-center">
                <small class="text-muted">Legend:</small>
                <div class="d-flex align-items-center gap-1">
                    <div style="width: 20px; height: 20px; background-color: #877BAF; border-radius: 3px;"></div>
                    <small>Available</small>
                </div>
                <div class="d-flex align-items-center gap-1">
                    <div style="width: 20px; height: 20px; background-color: #28a745; border-radius: 3px;"></div>
                    <small>Booked</small>
                </div>
                <div class="d-flex align-items-center gap-1">
                    <div style="width: 20px; height: 20px; background-color: #ffc107; border-radius: 3px;"></div>
                    <small>Blocked</small>
                </div>
                <div class="d-flex align-items-center gap-1">
                    <div style="width: 20px; height: 20px; background-color: #6c757d; border-radius: 3px;"></div>
                    <small>Completed</small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom styling for Radzen Scheduler */
    .rz-scheduler {
        border: none !important;
    }

    .rz-scheduler-appointment {
        border-radius: 4px !important;
        font-size: 0.85rem !important;
    }

    .rz-scheduler-timeline {
        border: 1px solid #dee2e6 !important;
    }

    .rz-scheduler-view {
        border: 1px solid #dee2e6 !important;
    }

    /* Status-based colors */
    .appointment-available {
        background-color: #877BAF !important;
        border-color: #6d5f8f !important;
        color: white !important;
    }

    .appointment-booked {
        background-color: #28a745 !important;
        border-color: #1e7e34 !important;
        color: white !important;
    }

    .appointment-blocked {
        background-color: #ffc107 !important;
        border-color: #d39e00 !important;
        color: #000 !important;
    }

    .appointment-completed {
        background-color: #6c757d !important;
        border-color: #545b62 !important;
        color: white !important;
    }

    /* Custom Timeline Styles */
    .timeline-event {
        padding: 6px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

        .timeline-event:hover {
            opacity: 0.85;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .timeline-event.available {
            background-color: #877BAF;
            color: white;
            border-left: 3px solid #6d5f8f;
        }

        .timeline-event.booked {
            background-color: #28a745;
            color: white;
            border-left: 3px solid #1e7e34;
        }

        .timeline-event.blocked {
            background-color: #ffc107;
            color: #000;
            border-left: 3px solid #d39e00;
        }

        .timeline-event.completed {
            background-color: #6c757d;
            color: white;
            border-left: 3px solid #545b62;
        }
</style>

@code {
    RadzenScheduler<AppointmentData> scheduler;
    List<AppointmentData> allSchedules = new();
    List<AppointmentData> filteredSchedules = new();

    private int selectedStaffId = 0;
    private string selectedStatus = "";
    private int selectedView = 0; // 0=Month, 1=Custom Timeline
    private bool showCustomTimeline = false;
    private DateTime currentNavDate = DateTime.Today;

    // Add a key to force re-render of the scheduler
    private string schedulerKey => $"scheduler-{currentNavDate:yyyyMM}-{selectedView}";

    private List<StaffItem> staffList = new();

    public class AppointmentData
    {
        public int ScheduleId { get; set; }
        public DateTime Start { get; set; }
        public DateTime End { get; set; }
        public string Text { get; set; } = string.Empty;
        public int StaffId { get; set; }
        public string StaffName { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string? PatientName { get; set; }
    }

    public class StaffItem
    {
        public int Value { get; set; }
        public string Text { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadStaffListAsync();
        await LoadSchedulesAsync();
        FilterSchedules();
    }

    private async Task LoadStaffListAsync()
    {
        try
        {
            var staffMembers = await PatientService.GetAllStaffAsync();
            staffList = new List<StaffItem>
            {
                new StaffItem { Value = 0, Text = "All Staff" }
            };

            foreach (var staff in staffMembers)
            {
                var firstName = staff.User?.FirstName ?? "";
                var lastName = staff.User?.LastName ?? "";
                var fullName = $"{firstName} {lastName}".Trim();
                var role = staff.User?.Role ?? "N/A";

                staffList.Add(new StaffItem
                {
                    Value = staff.Id,
                    Text = $"{fullName} ({role})"
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading staff list: {ex.Message}");
            staffList = new List<StaffItem>
            {
                new StaffItem { Value = 0, Text = "All Staff" }
            };
        }
    }

    private async Task LoadSchedulesAsync()
    {
        try
        {
            var schedules = await PatientService.GetAllSchedulesAsync();
            allSchedules = schedules.Select(s => new AppointmentData
            {
                ScheduleId = s.Id,
                Start = s.StartTime,
                End = s.EndTime,
                StaffId = s.StaffId,
                StaffName = s.Staff?.User != null
                    ? $"{s.Staff.User.FirstName} {s.Staff.User.LastName}".Trim()
                    : "N/A",
                Role = s.Staff?.User?.Role ?? "N/A",
                Text = $"{(s.Staff?.User != null ? $"{s.Staff.User.FirstName} {s.Staff.User.LastName}".Trim() : "N/A")} - {s.ShiftType ?? "Shift"}",
                Status = s.Status ?? "Available",
                PatientName = null // Will be populated if appointment exists
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading schedules: {ex.Message}");
            allSchedules = new List<AppointmentData>();
        }
    }

    private void FilterSchedules()
    {
        var query = allSchedules.AsEnumerable();

        if (selectedStaffId > 0)
        {
            query = query.Where(s => s.StaffId == selectedStaffId);
        }

        if (!string.IsNullOrEmpty(selectedStatus))
        {
            query = query.Where(s => s.Status == selectedStatus);
        }

        filteredSchedules = query.ToList();
    }

    private void OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        // When user clicks on empty time slot - navigate to create page
        Navigation.NavigateTo($"/admin/schedule/create?date={args.Start:yyyy-MM-dd}&time={args.Start:HH:mm}");
    }

    private void OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<AppointmentData> args)
    {
        // When user clicks on an appointment - navigate to details page
        Navigation.NavigateTo($"/admin/schedule/details/{args.Data.ScheduleId}");
    }

    private void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<AppointmentData> args)
    {
        // Apply custom CSS class based on status
        args.Attributes["class"] = $"rz-scheduler-appointment appointment-{args.Data.Status.ToLower()}";

        // Add tooltip
        var tooltip = $"{args.Data.StaffName} - {args.Data.Status}";
        if (!string.IsNullOrEmpty(args.Data.PatientName))
        {
            tooltip += $"\nPatient: {args.Data.PatientName}";
        }
        args.Attributes["title"] = tooltip;
    }

    private void OnSlotRender(SchedulerSlotRenderEventArgs args)
    {
        // Highlight current time slot
        if (args.Start <= DateTime.Now && args.End > DateTime.Now)
        {
            args.Attributes["style"] = "background-color: rgba(135, 123, 175, 0.1);";
        }

        // Highlight today in month view
        if (args.View.Text == "Month" && args.Start.Date == DateTime.Today)
        {
            args.Attributes["style"] = "background-color: #fff3cd;";
        }
    }

    private void OnLoadData(SchedulerLoadDataEventArgs args)
    {
        // This is called when the scheduler needs to load data for a specific date range
        // You can implement lazy loading here to fetch data from database
        // based on args.Start and args.End dates
    }

    private DateTime GetTimelineWeekStart()
    {
        var diff = (7 + (currentNavDate.DayOfWeek - DayOfWeek.Monday)) % 7;
        return currentNavDate.AddDays(-1 * diff).Date;
    }

    private string GetCurrentPeriodTitle()
    {
        if (showCustomTimeline)
        {
            var start = GetTimelineWeekStart();
            var end = start.AddDays(6);
            return $"{start:MMM dd} - {end:MMM dd, yyyy}";
        }
        else
        {
            // For Month view, show the month and year
            return currentNavDate.ToString("MMMM yyyy");
        }
    }

    private void NavigatePrevious()
    {
        if (showCustomTimeline)
        {
            currentNavDate = currentNavDate.AddDays(-7);
        }
        else
        {
            // For Month view, navigate to previous month
            currentNavDate = currentNavDate.AddMonths(-1);
        }
        StateHasChanged();
        // Force the scheduler to reload data for the new date range
        if (scheduler != null && !showCustomTimeline)
        {
            scheduler.Reload();
        }
    }

    private void NavigateNext()
    {
        if (showCustomTimeline)
        {
            currentNavDate = currentNavDate.AddDays(7);
        }
        else
        {
            // For Month view, navigate to next month
            currentNavDate = currentNavDate.AddMonths(1);
        }
        StateHasChanged();
        // Force the scheduler to reload data for the new date range
        if (scheduler != null && !showCustomTimeline)
        {
            scheduler.Reload();
        }
    }

    private void NavigateToday()
    {
        currentNavDate = DateTime.Today;
        StateHasChanged();

        // Force the scheduler to reload data for the new date range
        if (scheduler != null && !showCustomTimeline)
        {
            scheduler.Reload();
        }
    }

    private string GetStaffNameOnly(string fullText)
    {
        // Extract "Dr. Sarah Williams" from "Dr. Sarah Williams (Doctor)"
        var parenIndex = fullText.IndexOf('(');
        return parenIndex > 0 ? fullText.Substring(0, parenIndex).Trim() : fullText;
    }

    private string GetStaffRole(string fullText)
    {
        // Extract "Doctor" from "Dr. Sarah Williams (Doctor)"
        var startIndex = fullText.IndexOf('(');
        var endIndex = fullText.IndexOf(')');
        if (startIndex > 0 && endIndex > startIndex)
        {
            return fullText.Substring(startIndex + 1, endIndex - startIndex - 1);
        }
        return "";
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower();
    }

    private string GetTooltip(AppointmentData schedule)
    {
        var tooltip = $"{schedule.StaffName}\n{schedule.Start:HH:mm} - {schedule.End:HH:mm}\nStatus: {schedule.Status}";
        if (!string.IsNullOrEmpty(schedule.PatientName))
        {
            tooltip += $"\nPatient: {schedule.PatientName}";
        }
        return tooltip;
    }

    private void OnDayClick(DateTime date, int staffId)
    {
        Navigation.NavigateTo($"/admin/schedule/create?date={date:yyyy-MM-dd}&staffId={staffId}");
    }

    private void OnAppointmentClick(int scheduleId)
    {
        Navigation.NavigateTo($"/patient/schedule/details/{scheduleId}");
    }

    private void SwitchToView(int viewIndex)
    {
        if (viewIndex == 1)
        {
            // Switch to custom timeline
            showCustomTimeline = true;
            currentNavDate = DateTime.Today;
        }
        else
        {
            // Switch to Radzen Month view
            showCustomTimeline = false;
            selectedView = viewIndex;
        }
        StateHasChanged();
    }

    private void CreateSchedule()
    {
        Navigation.NavigateTo($"/admin/schedule/create?date={currentNavDate:yyyy-MM-dd}");
    }
}