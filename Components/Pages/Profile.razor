@page "/profile"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@using System.ComponentModel.DataAnnotations
@using HMS.Data
@using HMS.Models
@using HMS.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize] 

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            @if (isLoading)
            {
                <div class="card">
                    <div class="card-body text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <EditForm Model="@profileData" OnValidSubmit="HandleSave">
                    <DataAnnotationsValidator />

                    <!-- Profile Header -->
                    <div class="card mb-4">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center justify-content-between mb-4">
                                <div class="d-flex align-items-center gap-3">
                                    <img src="https://ui-avatars.com/api/?name=@GetFullName()&size=80&background=0ea5e9&color=fff&bold=true"
                                         class="rounded-circle" alt="Profile" style="width: 80px; height: 80px;">
                                    <div>
                                        <h3 class="mb-1">@GetFullName()</h3>
                                        <p class="text-muted mb-0">@GetUserRole()</p>
                                    </div>
                                </div>
                                @if (!isEditMode)
                                {
                                    <button type="button" class="btn btn-primary" @onclick="EnableEditMode">
                                        <i class="bi bi-pencil me-1"></i> Edit
                                    </button>
                                }
                            </div>

                            <!-- Contact Info -->
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Email</label>
                                    @if (isEditMode)
                                    {
                                        <input type="text" class="form-control" value="@profileData.Email" readonly />
                                    }
                                    else
                                    {
                                        <p class="mb-0">@profileData.Email</p>
                                    }
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Phone</label>
                                    @if (isEditMode)
                                    {
                                        <InputText @bind-Value="profileData.Phone" class="form-control" />
                                        <ValidationMessage For="@(() => profileData.Phone)" class="text-danger small" />
                                    }
                                    else
                                    {
                                        <p class="mb-0">@profileData.Phone</p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Patient Info -->
                    @if (userRole == "Patient")
                    {
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Personal Information</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">First Name</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.FirstName" class="form-control" />
                                            <ValidationMessage For="@(() => profileData.FirstName)" class="text-danger small" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.FirstName</p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Last Name</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.LastName" class="form-control" />
                                            <ValidationMessage For="@(() => profileData.LastName)" class="text-danger small" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.LastName</p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Blood Group</label>
                                        @if (isEditMode)
                                        {
                                            <InputSelect @bind-Value="profileData.BloodGroup" class="form-select">
                                                <option value="">Select</option>
                                                <option value="A+">A+</option>
                                                <option value="A-">A-</option>
                                                <option value="B+">B+</option>
                                                <option value="B-">B-</option>
                                                <option value="AB+">AB+</option>
                                                <option value="AB-">AB-</option>
                                                <option value="O+">O+</option>
                                                <option value="O-">O-</option>
                                            </InputSelect>
                                        }
                                        else
                                        {
                                            <p class="mb-0"><span class="badge bg-danger">@profileData.BloodGroup</span></p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Date of Birth</label>
                                        @if (isEditMode)
                                        {
                                            <InputDate @bind-Value="profileData.DateOfBirth" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.DateOfBirth?.ToString("yyyy-MM-dd")</p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Address</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Address" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Address</p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Contact</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Contact" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Contact</p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Preferences</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Preferences" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Preferences</p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Interests</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Interests" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Interests</p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Created At</label>
                                        <p class="mb-0 text-muted">@profileData.CreatedAt?.ToString("yyyy-MM-dd HH:mm")</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-primary mb-0">12</h2>
                                        <p class="text-muted mb-0">Total Visits</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-success mb-0">8</h2>
                                        <p class="text-muted mb-0">Completed</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-warning mb-0">2</h2>
                                        <p class="text-muted mb-0">Upcoming</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Staff Info -->
                    @if (userRole == "Staff" || userRole == "Admin")
                    {
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Employment Information</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Department</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Department" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Department</p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Specialization</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Specialization" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Specialization</p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Contract Type</label>
                                        @if (isEditMode)
                                        {
                                            <InputSelect @bind-Value="profileData.ContractForm" class="form-select">
                                                <option value="">Select</option>
                                                <option value="Full-Time">Full-Time</option>
                                                <option value="Part-Time">Part-Time</option>
                                                <option value="Contract">Contract</option>
                                            </InputSelect>
                                        }
                                        else
                                        {
                                            <p class="mb-0"><span class="badge bg-primary">@profileData.ContractForm</span></p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Hired Date</label>
                                        <p class="mb-0">@profileData.HiredDate?.ToString("yyyy-MM-dd")</p>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Vacation Days</label>
                                        <p class="mb-0">@profileData.VacationDays days remaining</p>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Hourly Rate</label>
                                        <p class="mb-0">@profileData.HourlyRate?.ToString("C") / hour</p>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Taxes</label>
                                        <p class="mb-0">@profileData.Taxes?.ToString("C") annually</p>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Bank Account</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.BankDetails" class="form-control" placeholder="SE1234567890" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@GetMaskedBankDetails()</p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">User ID</label>
                                        <p class="mb-0 text-muted small">@profileData.UserId</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-primary mb-0">45</h2>
                                        <p class="text-muted small mb-0">Appointments</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-success mb-0">160</h2>
                                        <p class="text-muted small mb-0">Hours</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-info mb-0">@profileData.VacationDays</h2>
                                        <p class="text-muted small mb-0">Vacation Days</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-primary mb-0">@profileData.HourlyRate?.ToString("C")</h2>
                                        <p class="text-muted small mb-0">Hourly Rate</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Save Buttons -->
                    @if (isEditMode)
                    {
                        <div class="card mt-4">
                            <div class="card-body p-3">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-lg me-1"></i> Save
                                    </button>
                                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">
                                        <i class="bi bi-x-lg me-1"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </EditForm>
            }
        </div>
    </div>
</div>



@code {
    [Inject] private PatientService PatientService { get; set; } = default!;
    [Inject] private AuthenticationStateProvider AuthenticationStateProvider { get; set; } = default!;
    [Inject] private Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> UserManager { get; set; } = default!;

    // view-model used by the page
    private ProfileData profileData = new();
    private string userRole = "Patient"; 
    private bool isEditMode = false;
    private bool isLoading = true;
    private string? statusMessage;
    private string? errorMessage;

    private HMS.Models.Patient? loadedPatient;
    private ApplicationUser? loadedUser;

    public class ProfileData
    {
        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Phone]
        public string Phone { get; set; } = string.Empty;

        public string UserId { get; set; } = string.Empty;

        // Patient model fields (map to Patient.Dateofbirth, Patient.Address, etc.)
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public DateTime? DateOfBirth { get; set; }
        public string Address { get; set; } = string.Empty;
        public string Contact { get; set; } = string.Empty;
        public string BloodGroup { get; set; } = string.Empty;
        public DateTime? CreatedAt { get; set; }
        public string Preferences { get; set; } = string.Empty;
        public string Interests { get; set; } = string.Empty;

        // Staff-specific
        public string ContractForm { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public decimal? Taxes { get; set; }
        public string BankDetails { get; set; } = string.Empty;
        public int VacationDays { get; set; }
        public string Specialization { get; set; } = string.Empty;
        public decimal? HourlyRate { get; set; }
        public DateTime? HiredDate { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated != true)
            {
                errorMessage = "You must be logged in to view your profile.";
                isLoading = false;
                return;
            }

            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userIdClaim))
            {
                errorMessage = "Unable to determine your user id.";
                isLoading = false;
                return;
            }

            if (user.IsInRole("Admin"))
                userRole = "Admin";
            else if (user.IsInRole("Staff"))
                userRole = "Staff";
            else
                userRole = "Patient";

            if (userRole == "Patient")
            {
                loadedPatient = await PatientService.GetPatientProfileAsync(userIdClaim);
                if (loadedPatient != null)
                {
                    loadedUser = loadedPatient.User;
                    MapPatientToProfile(loadedPatient, loadedUser);
                }
                else
                {
                    // optional fallback
                    loadedUser = await UserManager.FindByIdAsync(userIdClaim);
                    MapUserToProfile(loadedUser);
                }
            }
            else
            {
                loadedUser = await UserManager.FindByIdAsync(userIdClaim);
                MapUserToProfile(loadedUser);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading profile: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    // Map DB Patient + ApplicationUser -> view model
    private void MapPatientToProfile(HMS.Models.Patient? patient, ApplicationUser? user)
    {
        if (patient == null && user == null)
            return;

        profileData = new ProfileData
        {
            UserId = user?.Id ?? patient?.UserId ?? string.Empty,
            Email = user?.Email ?? string.Empty,
            Phone = user?.PhoneNumber ?? string.Empty,

            FirstName = user?.FirstName ?? string.Empty,
            LastName = user?.LastName ?? string.Empty,

            DateOfBirth = patient?.Dateofbirth,
            Address = patient?.Address ?? string.Empty,
            Contact = patient?.Contact ?? string.Empty,
            BloodGroup = patient?.BloodGroup ?? string.Empty,
            CreatedAt = patient?.Createdat,

            Preferences = patient?.Preferences ?? string.Empty,
            Interests = patient?.Interests ?? string.Empty,
        };
    }

    private void MapUserToProfile(ApplicationUser? user)
    {
        if (user == null)
        {
            profileData = new ProfileData();
            return;
        }

        profileData = new ProfileData
        {
            UserId = user.Id,
            Email = user.Email ?? string.Empty,
            Phone = user.PhoneNumber ?? string.Empty,

            FirstName = user.FirstName ?? string.Empty,
            LastName = user.LastName ?? string.Empty
        };
    }

    private void EnableEditMode() => isEditMode = true;

    private void CancelEdit()
    {
        isEditMode = false;
        _ = OnInitializedAsync();
    }

    private async Task HandleSave()
    {
        isLoading = true;
        statusMessage = null;
        errorMessage = null;

        try
        {
            if (loadedPatient == null && !string.IsNullOrEmpty(profileData.UserId))
            {
                loadedPatient = await PatientService.GetPatientProfileAsync(profileData.UserId);
            }

            // Update Patient entity if exists
            if (loadedPatient != null)
            {
                loadedPatient.Address = profileData.Address;
                loadedPatient.Contact = profileData.Contact;
                loadedPatient.Dateofbirth = profileData.DateOfBirth ?? loadedPatient.Dateofbirth;
                loadedPatient.BloodGroup = profileData.BloodGroup;
                loadedPatient.Preferences = profileData.Preferences;
                loadedPatient.Interests = profileData.Interests;

                var (success, message) = await PatientService.UpdatePatientProfileAsync(loadedPatient);
                if (!success)
                {
                    errorMessage = message;
                    return;
                }
            }

            // Update Identity user fields via UserManager
            if (!string.IsNullOrEmpty(profileData.UserId))
            {
                var user = await UserManager.FindByIdAsync(profileData.UserId);
                if (user != null)
                {
                    bool needUpdate = false;

                    if (user.Email != profileData.Email)
                    {
                        user.Email = profileData.Email;
                        user.NormalizedEmail = UserManager.NormalizeEmail(profileData.Email);
                        needUpdate = true;
                    }

                    if (user.FirstName != profileData.FirstName)
                    {
                        user.FirstName = profileData.FirstName;
                        needUpdate = true;
                    }
                    if (user.LastName != profileData.LastName)
                    {
                        user.LastName = profileData.LastName;
                        needUpdate = true;
                    }

                    if (user.PhoneNumber != profileData.Phone)
                    {
                        user.PhoneNumber = profileData.Phone;
                        needUpdate = true;
                    }

                    if (needUpdate)
                    {
                        var identityResult = await UserManager.UpdateAsync(user);
                        if (!identityResult.Succeeded)
                        {
                            errorMessage = identityResult.Errors.FirstOrDefault()?.Description ?? "Failed to update user";
                            return;
                        }
                    }
                }
            }

            statusMessage = "Profile updated successfully.";
            isEditMode = false;

            await OnInitializedAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving profile: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetFullName()
    {
        if (!string.IsNullOrWhiteSpace(profileData.FirstName) || !string.IsNullOrWhiteSpace(profileData.LastName))
            return $"{profileData.FirstName} {profileData.LastName}".Trim();
        return profileData.Email ?? "User";
    }

    private string GetUserRole() => userRole;

    private string GetMaskedBankDetails()
    {
        if (string.IsNullOrEmpty(profileData.BankDetails) || profileData.BankDetails.Length <= 4)
            return profileData.BankDetails;
        return "****" + profileData.BankDetails.Substring(profileData.BankDetails.Length - 4);
    }
}
