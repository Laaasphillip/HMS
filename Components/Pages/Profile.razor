@page "/profile"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@using System.ComponentModel.DataAnnotations
@* @using Microsoft.AspNetCore.Authorization
@attribute [Authorize] *@

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            @if (isLoading)
            {
                <div class="card">
                    <div class="card-body text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <EditForm Model="@profileData" OnValidSubmit="HandleSave">
                    <DataAnnotationsValidator />

                    <!-- Profile Header -->
                    <div class="card mb-4">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center justify-content-between mb-4">
                                <div class="d-flex align-items-center gap-3">
                                    <img src="https://ui-avatars.com/api/?name=@GetFullName()&size=80&background=0ea5e9&color=fff&bold=true"
                                         class="rounded-circle" alt="Profile" style="width: 80px; height: 80px;">
                                    <div>
                                        <h3 class="mb-1">@GetFullName()</h3>
                                        <p class="text-muted mb-0">@GetUserRole()</p>
                                    </div>
                                </div>
                                @if (!isEditMode)
                                {
                                    <button type="button" class="btn btn-primary" @onclick="EnableEditMode">
                                        <i class="bi bi-pencil me-1"></i> Edit
                                    </button>
                                }
                            </div>

                            <!-- Contact Info -->
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Email</label>
                                    @if (isEditMode)
                                    {
                                        <input type="text" class="form-control" value="@profileData.Email" readonly />
                                    }
                                    else
                                    {
                                        <p class="mb-0">@profileData.Email</p>
                                    }
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Phone</label>
                                    @if (isEditMode)
                                    {
                                        <InputText @bind-Value="profileData.Phone" class="form-control" />
                                        <ValidationMessage For="@(() => profileData.Phone)" class="text-danger small" />
                                    }
                                    else
                                    {
                                        <p class="mb-0">@profileData.Phone</p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Patient Info -->
                    @if (userRole == "Patient")
                    {
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Personal Information</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">First Name</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.FirstName" class="form-control" />
                                            <ValidationMessage For="@(() => profileData.FirstName)" class="text-danger small" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.FirstName</p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Last Name</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.LastName" class="form-control" />
                                            <ValidationMessage For="@(() => profileData.LastName)" class="text-danger small" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.LastName</p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Blood Group</label>
                                        @if (isEditMode)
                                        {
                                            <InputSelect @bind-Value="profileData.BloodGroup" class="form-select">
                                                <option value="">Select</option>
                                                <option value="A+">A+</option>
                                                <option value="A-">A-</option>
                                                <option value="B+">B+</option>
                                                <option value="B-">B-</option>
                                                <option value="AB+">AB+</option>
                                                <option value="AB-">AB-</option>
                                                <option value="O+">O+</option>
                                                <option value="O-">O-</option>
                                            </InputSelect>
                                        }
                                        else
                                        {
                                            <p class="mb-0"><span class="badge bg-danger">@profileData.BloodGroup</span></p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Date of Birth</label>
                                        @if (isEditMode)
                                        {
                                            <InputDate @bind-Value="profileData.DateOfBirth" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.DateOfBirth?.ToString("yyyy-MM-dd")</p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Address</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Address" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Address</p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Contact</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Contact" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Contact</p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Preferences</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Preferences" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Preferences</p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Interests</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Interests" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Interests</p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Created At</label>
                                        <p class="mb-0 text-muted">@profileData.CreatedAt?.ToString("yyyy-MM-dd HH:mm")</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-primary mb-0">12</h2>
                                        <p class="text-muted mb-0">Total Visits</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-success mb-0">8</h2>
                                        <p class="text-muted mb-0">Completed</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-warning mb-0">2</h2>
                                        <p class="text-muted mb-0">Upcoming</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Staff Info -->
                    @if (userRole == "Staff" || userRole == "Doctor" || userRole == "Nurse")
                    {
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Employment Information</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Department</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Department" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Department</p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Specialization</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.Specialization" class="form-control" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@profileData.Specialization</p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Contract Type</label>
                                        @if (isEditMode)
                                        {
                                            <InputSelect @bind-Value="profileData.ContractForm" class="form-select">
                                                <option value="">Select</option>
                                                <option value="Full-Time">Full-Time</option>
                                                <option value="Part-Time">Part-Time</option>
                                                <option value="Contract">Contract</option>
                                            </InputSelect>
                                        }
                                        else
                                        {
                                            <p class="mb-0"><span class="badge bg-primary">@profileData.ContractForm</span></p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Hired Date</label>
                                        <p class="mb-0">@profileData.HiredDate?.ToString("yyyy-MM-dd")</p>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Vacation Days</label>
                                        <p class="mb-0">@profileData.VacationDays days remaining</p>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Hourly Rate</label>
                                        <p class="mb-0">@profileData.HourlyRate?.ToString("C") / hour</p>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Taxes</label>
                                        <p class="mb-0">@profileData.Taxes?.ToString("C") annually</p>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Bank Account</label>
                                        @if (isEditMode)
                                        {
                                            <InputText @bind-Value="profileData.BankDetails" class="form-control" placeholder="SE1234567890" />
                                        }
                                        else
                                        {
                                            <p class="mb-0">@GetMaskedBankDetails()</p>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">User ID</label>
                                        <p class="mb-0 text-muted small">@profileData.UserId</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-primary mb-0">45</h2>
                                        <p class="text-muted small mb-0">Appointments</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-success mb-0">160</h2>
                                        <p class="text-muted small mb-0">Hours</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-info mb-0">@profileData.VacationDays</h2>
                                        <p class="text-muted small mb-0">Vacation Days</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h2 class="text-primary mb-0">@profileData.HourlyRate?.ToString("C")</h2>
                                        <p class="text-muted small mb-0">Hourly Rate</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Save Buttons -->
                    @if (isEditMode)
                    {
                        <div class="card mt-4">
                            <div class="card-body p-3">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-lg me-1"></i> Save
                                    </button>
                                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">
                                        <i class="bi bi-x-lg me-1"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </EditForm>
            }
        </div>
    </div>
</div>

<style>
    .card {
        border: none;
        box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        border-radius: 8px;
    }

    .card-header {
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
    }

    .form-control, .form-select {
        border: 1px solid #dee2e6;
        border-radius: 6px;
    }

        .form-control:focus, .form-select:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 0.2rem rgba(14, 165, 233, 0.15);
        }

    .btn-primary {
        background-color: #0ea5e9;
        border-color: #0ea5e9;
    }

        .btn-primary:hover {
            background-color: #0284c7;
            border-color: #0284c7;
        }
</style>

@code {
    private ProfileData profileData = new();
    private string userRole = "Staff";
    private bool isEditMode = false;
    private bool isLoading = false;

    public class ProfileData
    {
        // Common Identity fields
        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Phone]
        public string Phone { get; set; } = string.Empty;

        public int UserId { get; set; }

        // Patient-specific fields (from Patient model)
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public DateTime? DateOfBirth { get; set; }
        public string Address { get; set; } = string.Empty;
        public string Contact { get; set; } = string.Empty;
        public string BloodGroup { get; set; } = string.Empty;
        public DateTime? CreatedAt { get; set; }
        public string Preferences { get; set; } = string.Empty;
        public string Interests { get; set; } = string.Empty;

        // Staff-specific fields (from Staff model)
        public string ContractForm { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public decimal? Taxes { get; set; }
        public string BankDetails { get; set; } = string.Empty;
        public int VacationDays { get; set; }
        public string Specialization { get; set; } = string.Empty;
        public decimal? HourlyRate { get; set; }
        public DateTime? HiredDate { get; set; }
    }

    protected override void OnInitialized()
    {
        LoadProfileData();
    }

    private void LoadProfileData()
    {
        if (userRole == "Patient")
        {
            profileData = new ProfileData
            {
                UserId = 1,
                Email = "john.doe@example.com",
                Phone = "+46 70 123 4567",
                FirstName = "John",
                LastName = "Doe",
                DateOfBirth = new DateTime(1990, 5, 15),
                Address = "123 Main Street, Stockholm",
                Contact = "+46 70 123 4567",
                BloodGroup = "A+",
                CreatedAt = new DateTime(2024, 1, 15),
                Preferences = "Morning appointments",
                Interests = "General health, Fitness"
            };
        }
        else
        {
            profileData = new ProfileData
            {
                UserId = 2001,
                Email = "sarah.williams@hospital.com",
                Phone = "+46 70 987 6543",
                ContractForm = "Full-Time",
                Department = "Cardiology",
                Specialization = "Interventional Cardiology",
                HourlyRate = 1500.00m,
                HiredDate = new DateTime(2020, 1, 15),
                VacationDays = 15,
                Taxes = 350000.00m,
                BankDetails = "SE1234567890123456"
            };
        }
    }

    private void EnableEditMode() => isEditMode = true;

    private void CancelEdit()
    {
        isEditMode = false;
        LoadProfileData();
    }

    private void HandleSave()
    {
        isEditMode = false;
    }

    private string GetFullName()
    {
        if (userRole == "Patient")
            return $"{profileData.FirstName} {profileData.LastName}";
        return "Dr. Sarah Williams";
    }

    private string GetUserRole() => userRole;

    private string GetMaskedBankDetails()
    {
        if (string.IsNullOrEmpty(profileData.BankDetails) || profileData.BankDetails.Length <= 4)
            return profileData.BankDetails;
        return "****" + profileData.BankDetails.Substring(profileData.BankDetails.Length - 4);
    }
}